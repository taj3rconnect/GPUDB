<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  body { font-family: 'Inter', sans-serif; background: #0a0a0f; }
  .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(20px); }
  .glass-bright { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
  .ring-bg { stroke: rgba(255,255,255,0.06); }
  .ring-fill { transition: stroke-dashoffset 0.8s ease; stroke-linecap: round; }
  .bar-track { background: rgba(255,255,255,0.06); }
  .bar-fill { transition: width 0.8s ease; }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)} 50%{box-shadow:0 0 0 6px rgba(34,197,94,0)} }
  @keyframes pulse-red { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,68,68,0)} }
  .status-online { animation: pulse-green 2s infinite; }
  .status-offline { animation: pulse-red 2s infinite; }
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
  .shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
  .gpu-card:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-1px); }
  .gpu-card { transition: all 0.2s ease; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  canvas { image-rendering: pixelated; }
  .tab-active { border-bottom: 2px solid #22c55e; color: #fff; }
  .tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
  .tab-inactive:hover { color: #9ca3af; }
  .kpi-card { transition: all 0.2s ease; }
  .kpi-card:hover { background: rgba(255,255,255,0.06); }
  .sparkline { display: inline-block; vertical-align: middle; }
</style>
<script>
tailwind.config = { theme: { extend: { colors: { surface: { 50:'#0a0a0f', 100:'#111118', 200:'#1a1a24' } } } } }
</script>
</head>
<body class="min-h-screen text-gray-200 p-4 md:p-6">

<!-- Header -->
<div class="max-w-[1900px] mx-auto mb-6">
  <div class="flex items-center justify-between flex-wrap gap-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
      </div>
      <div>
        <h1 class="text-xl font-semibold text-white">GPU Admin Dashboard</h1>
        <p class="text-xs text-gray-500">Real-time monitoring &middot; Traffic &middot; KPIs</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-xs text-gray-500">
        Refresh: <select id="refreshRate" onchange="updateRefreshRate()" class="bg-surface-100 border border-gray-700 rounded px-2 py-1 text-gray-300 text-xs">
          <option value="3000">3s</option><option value="5000">5s</option><option value="10000">10s</option><option value="30000">30s</option>
        </select>
      </div>
      <div id="lastUpdate" class="text-xs text-gray-500"></div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="max-w-[1900px] mx-auto mb-4 flex gap-6 border-b border-gray-800 pb-0">
  <button class="tab-active pb-2 text-sm font-medium px-1" onclick="switchTab('overview')" id="tab-overview">Overview</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('traffic')" id="tab-traffic">Traffic & KPIs</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('history')" id="tab-history">History & Peaks</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('software')" id="tab-software">Software & Tools</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('daily')" id="tab-daily">24h Report</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('agent')" id="tab-agent">Agent</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('analytics')" id="tab-analytics">Analytics & Cost</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('proactive')" id="tab-proactive">Alerts & Ops</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('capacity')" id="tab-capacity">Capacity Planner</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('quality')" id="tab-quality">Call Quality</button>
</div>

<!-- Content -->
<div class="max-w-[1900px] mx-auto">
  <div id="page-overview"></div>
  <div id="page-traffic" class="hidden"></div>
  <div id="page-history" class="hidden"></div>
  <div id="page-software" class="hidden"></div>
  <div id="page-daily" class="hidden"></div>
  <div id="page-agent" class="hidden"></div>
  <div id="page-analytics" class="hidden"></div>
  <div id="page-proactive" class="hidden"></div>
  <div id="page-capacity" class="hidden"></div>
  <div id="page-quality" class="hidden"></div>
</div>

<script>
const SERVERS = ['h200', 'rtx5090'];
let refreshInterval = null;
let refreshRate = 3000;
let serverData = {};
let historyData = {};
let prevNetData = {};
let activeTab = 'overview';
let softwareData = {};
let softwareLoaded = false;
let pypiCache = {};
let dailyData = {};
let dailyLoaded = false;
let agentData = null;
let analyticsData = null;
let analyticsLoaded = false;
let proactiveData = null;
let capacityData = null;
let qualityData = null;

// ── Utilities ──
function fmt(n) { return n.toLocaleString(); }
function formatBytes(b) { if(!b) return '0 B'; const g=b/(1024**3); return g>=1024?(g/1024).toFixed(1)+' TiB':g.toFixed(1)+' GiB'; }
function formatMiB(m) { return m>=1024?(m/1024).toFixed(1)+' GiB':m+' MiB'; }
function formatUptime(s) { const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60); return d>0?d+'d '+h+'h '+m+'m':h>0?h+'h '+m+'m':m+'m'; }
function formatRate(bps) { if(bps>=1e9) return (bps/1e9).toFixed(1)+' Gbps'; if(bps>=1e6) return (bps/1e6).toFixed(1)+' Mbps'; if(bps>=1e3) return (bps/1e3).toFixed(1)+' Kbps'; return bps.toFixed(0)+' bps'; }
function getColor(v,t) { return v>=t[1]?{ring:'#ef4444',bg:'rgba(239,68,68,0.15)',text:'text-red-400'}:v>=t[0]?{ring:'#f59e0b',bg:'rgba(245,158,11,0.15)',text:'text-amber-400'}:{ring:'#22c55e',bg:'rgba(34,197,94,0.12)',text:'text-emerald-400'}; }
function getTempColor(t){return getColor(t,[60,80]);}
function getUtilColor(u){return getColor(u,[50,85]);}
function getPowerColor(p){return getColor(p,[60,85]);}

function ringSVG(value,max,size,sw,color) {
  const r=(size-sw)/2, c=2*Math.PI*r, pct=Math.min(value/max,1), off=c*(1-pct);
  return `<svg width="${size}" height="${size}" class="transform -rotate-90"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke-width="${sw}" class="ring-bg"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke-width="${sw}" stroke="${color}" stroke-dasharray="${c}" stroke-dashoffset="${off}" class="ring-fill"/></svg>`;
}
function barHTML(v,m,c) { const p=m>0?Math.min((v/m)*100,100):0; return `<div class="bar-track rounded-full h-2 w-full"><div class="bar-fill rounded-full h-2" style="width:${p}%;background:${c}"></div></div>`; }

function sparklineSVG(data, width, height, color) {
  if (!data || data.length < 2) return '';
  const max = Math.max(...data, 1);
  const min = Math.min(...data, 0);
  const range = max - min || 1;
  const step = width / (data.length - 1);
  let path = '';
  data.forEach((v, i) => {
    const x = i * step;
    const y = height - ((v - min) / range) * (height - 4) - 2;
    path += (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
  });
  return `<svg width="${width}" height="${height}" class="sparkline"><path d="${path}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

// ── Tab Switching ──
function switchTab(tab) {
  activeTab = tab;
  ['overview','traffic','history','software','daily','agent','analytics','proactive','capacity','quality'].forEach(t => {
    document.getElementById('page-'+t).classList.toggle('hidden', t !== tab);
    document.getElementById('tab-'+t).className = t === tab ? 'tab-active pb-2 text-sm font-medium px-1' : 'tab-inactive pb-2 text-sm font-medium px-1';
  });
  renderAll();
  if (tab === 'software' && !softwareLoaded) loadSoftware();
  if (tab === 'daily' && !dailyLoaded) loadDaily();
  if (tab === 'agent') loadAgent();
  if (tab === 'analytics') loadAnalytics();
  if (tab === 'proactive') loadProactive();
  if (tab === 'capacity') loadCapacity();
  if (tab === 'quality') loadQuality();
}

// ── Overview Tab ──
function renderGPUCard(g, hasEcc) {
  const uc=getUtilColor(g.gpu_util), tc=getTempColor(g.temp||0);
  const pp=g.power_limit>0?(g.power_draw/g.power_limit*100):0, pc=getPowerColor(pp);
  const mp=g.mem_total>0?(g.mem_used/g.mem_total*100):0, mc=getColor(mp,[60,90]);
  return `<div class="gpu-card glass-bright rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs font-medium text-gray-400">GPU ${g.index}</span>
      <div class="flex items-center gap-2">
        ${g.fan!==null?`<span class="text-[10px] text-gray-500">${g.fan}% fan</span>`:''}
        ${hasEcc&&g.ecc_errors!==undefined?`<span class="text-[10px] ${g.ecc_errors>0?'text-red-400':'text-gray-600'}">ECC:${g.ecc_errors}</span>`:''}
      </div>
    </div>
    <div class="flex items-center gap-4 mb-3">
      <div class="relative flex-shrink-0">${ringSVG(g.gpu_util,100,64,5,uc.ring)}
        <div class="absolute inset-0 flex items-center justify-center"><span class="text-sm font-semibold ${uc.text}">${g.gpu_util}%</span></div>
      </div>
      <div class="flex-1 space-y-1.5">
        <div class="flex justify-between text-[11px]"><span class="text-gray-500">Temp</span><span class="${tc.text} font-medium">${g.temp!==null?g.temp+'°C':'N/A'}</span></div>
        <div class="flex justify-between text-[11px]"><span class="text-gray-500">Power</span><span class="${pc.text} font-medium">${g.power_draw.toFixed(0)}W/${g.power_limit.toFixed(0)}W</span></div>
      </div>
    </div>
    <div class="space-y-1.5">
      <div class="flex items-center justify-between text-[11px]"><span class="text-gray-500">VRAM</span><span class="text-gray-400">${formatMiB(g.mem_used)}/${formatMiB(g.mem_total)}</span></div>
      ${barHTML(g.mem_used,g.mem_total,mc.ring)}
    </div>
  </div>`;
}

function renderOverviewServer(key, d) {
  if (!d || d.status==='offline') {
    return `<div class="glass rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="w-2.5 h-2.5 rounded-full bg-red-500 status-offline"></div><h2 class="text-lg font-semibold text-white">${d?.server_name||key}</h2><span class="text-xs text-gray-500">${d?.host||''}</span></div><div class="text-red-400 text-sm">Connection failed: ${d?.error||'Unknown'}</div></div>`;
  }
  const gpus=d.gpus||[], procs=d.processes||[];
  const tv=gpus.reduce((s,g)=>s+g.mem_total,0), uv=gpus.reduce((s,g)=>s+g.mem_used,0);
  const au=gpus.length?Math.round(gpus.reduce((s,g)=>s+g.gpu_util,0)/gpus.length):0;
  const tp=gpus.reduce((s,g)=>s+g.power_draw,0), tc=gpus.reduce((s,g)=>s+g.power_limit,0);
  const vp=tv>0?((uv/tv)*100).toFixed(0):0;

  // System bars
  let sys='';
  if(d.ram?.total){sys+=`<div class="flex items-center gap-2"><span class="text-gray-500 text-xs w-12">RAM</span><div class="flex-1">${barHTML(d.ram.used,d.ram.total,'#6366f1')}</div><span class="text-xs text-gray-400 w-28 text-right">${formatBytes(d.ram.used)} / ${formatBytes(d.ram.total)}</span></div>`;}
  if(d.disk?.total){sys+=`<div class="flex items-center gap-2"><span class="text-gray-500 text-xs w-12">Disk</span><div class="flex-1">${barHTML(d.disk.used,d.disk.total,'#8b5cf6')}</div><span class="text-xs text-gray-400 w-28 text-right">${formatBytes(d.disk.used)} / ${formatBytes(d.disk.total)}</span></div>`;}

  // Net throughput
  let netHtml = '';
  if (prevNetData[key]) {
    const dt = (d.timestamp - prevNetData[key].t) || 1;
    const rxRate = ((d.net_rx_bytes - prevNetData[key].rx) * 8) / dt;
    const txRate = ((d.net_tx_bytes - prevNetData[key].tx) * 8) / dt;
    if (rxRate >= 0 && txRate >= 0) {
      netHtml = `<div class="flex items-center gap-4 text-[11px] mt-1"><span class="text-gray-500">Net:</span><span class="text-cyan-400">↓ ${formatRate(rxRate)}</span><span class="text-emerald-400">↑ ${formatRate(txRate)}</span></div>`;
    }
  }
  prevNetData[key] = { t: d.timestamp, rx: d.net_rx_bytes, tx: d.net_tx_bytes };

  // Procs
  let procHTML='';
  if(procs.length>0){
    const up={};procs.forEach(p=>{const k=p.pid+p.name;if(!up[k])up[k]={...p,count:1};else{up[k].mem_used+=p.mem_used;up[k].count++;}});
    const pl=Object.values(up).sort((a,b)=>b.mem_used-a.mem_used).slice(0,8);
    procHTML=`<details class="mt-4"><summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Processes (${procs.length})</summary><div class="mt-2 space-y-1">${pl.map(p=>`<div class="flex justify-between text-[11px] text-gray-400 py-1 px-2 rounded hover:bg-white/[0.03]"><span class="truncate flex-1 mr-2" title="${p.name}">${p.name}</span><span class="text-gray-500 flex-shrink-0">PID ${p.pid} · ${formatMiB(p.mem_used)}</span></div>`).join('')}</div></details>`;
  }

  return `<div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full bg-emerald-500 status-online"></div><h2 class="text-lg font-semibold text-white">${d.server_name}</h2><span class="text-xs text-gray-500 font-mono">${d.host}</span></div>
      <div class="text-xs text-gray-500">up ${formatUptime(d.uptime_seconds)}</div>
    </div>
    <div class="grid grid-cols-4 gap-3 mb-4">
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">GPUs</div><div class="text-lg font-semibold text-white">${gpus.length}</div><div class="text-[10px] text-gray-500">${d.gpu_model.replace('NVIDIA ','').replace('GeForce ','')}</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Avg Util</div><div class="text-lg font-semibold ${getUtilColor(au).text}">${au}%</div><div class="text-[10px] text-gray-500">compute</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Total VRAM</div><div class="text-lg font-semibold text-white">${vp}%</div><div class="text-[10px] text-gray-500">${formatMiB(uv)} / ${formatMiB(tv)}</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Power</div><div class="text-lg font-semibold ${getPowerColor(tc>0?tp/tc*100:0).text}">${tp.toFixed(0)}W</div><div class="text-[10px] text-gray-500">/ ${tc.toFixed(0)}W cap</div></div>
    </div>
    <div class="space-y-2 mb-4">${sys}${netHtml}</div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">${gpus.map(g=>renderGPUCard(g, d.gpu_model.includes('H200'))).join('')}</div>
    ${procHTML}
  </div>`;
}

function renderOverview() {
  const el = document.getElementById('page-overview');
  el.innerHTML = `<div class="grid grid-cols-1 2xl:grid-cols-2 gap-6">${SERVERS.map(k => renderOverviewServer(k, serverData[k])).join('')}</div>`;
}

// ── Traffic & KPIs Tab ──
function renderVllmService(v) {
  const shortModel = v.model_name.split('/').pop();
  return `<div class="glass-bright rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div><span class="text-sm font-medium text-white">${shortModel}</span><span class="text-[10px] text-gray-500 ml-2">:${v.port}</span></div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${v.requests_running>0?'bg-emerald-500/20 text-emerald-400':'bg-gray-700/50 text-gray-500'}">${v.requests_running} running</span>
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${v.requests_waiting>0?'bg-amber-500/20 text-amber-400':'bg-gray-700/50 text-gray-500'}">${v.requests_waiting} queued</span>
      </div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Total Requests</div><div class="text-base font-semibold text-white">${fmt(v.total_requests)}</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Prompt Tokens</div><div class="text-base font-semibold text-cyan-400">${(v.prompt_tokens/1e6).toFixed(1)}M</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Gen Tokens</div><div class="text-base font-semibold text-purple-400">${(v.generation_tokens/1e6).toFixed(1)}M</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Success</div><div class="text-base font-semibold text-emerald-400">${fmt(v.success_count)}</div></div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg TTFT</div><div class="text-sm font-semibold ${v.avg_ttft_ms>500?'text-red-400':v.avg_ttft_ms>200?'text-amber-400':'text-emerald-400'}">${v.avg_ttft_ms.toFixed(0)}ms</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg ITL</div><div class="text-sm font-semibold ${v.avg_itl_ms>100?'text-red-400':v.avg_itl_ms>50?'text-amber-400':'text-emerald-400'}">${v.avg_itl_ms.toFixed(1)}ms</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg E2E</div><div class="text-sm font-semibold text-gray-300">${v.avg_e2e_s.toFixed(2)}s</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg Queue</div><div class="text-sm font-semibold ${v.avg_queue_s>1?'text-red-400':v.avg_queue_s>0.5?'text-amber-400':'text-emerald-400'}">${v.avg_queue_s.toFixed(3)}s</div></div>
    </div>
    <div class="grid grid-cols-2 gap-3 mt-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">KV Cache</div><div class="text-sm font-semibold text-white">${v.kv_cache_usage}%</div>${barHTML(v.kv_cache_usage,100,'#f59e0b')}</div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Prefix Cache Hit</div><div class="text-sm font-semibold text-white">${v.cache_hit_rate}%</div>${barHTML(v.cache_hit_rate,100,'#22c55e')}</div>
    </div>
  </div>`;
}

function renderTraffic() {
  const el = document.getElementById('page-traffic');
  let html = '';
  for (const key of SERVERS) {
    const d = serverData[key];
    if (!d || d.status === 'offline') continue;
    const vllm = d.vllm || [];
    if (vllm.length === 0) {
      html += `<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white mb-2">${d.server_name}</h3><p class="text-gray-500 text-sm">No vLLM services detected</p></div>`;
      continue;
    }
    // Aggregate KPIs
    const totalReqs = vllm.reduce((s,v)=>s+v.total_requests,0);
    const totalPrompt = vllm.reduce((s,v)=>s+v.prompt_tokens,0);
    const totalGen = vllm.reduce((s,v)=>s+v.generation_tokens,0);
    const totalRunning = vllm.reduce((s,v)=>s+v.requests_running,0);
    const totalWaiting = vllm.reduce((s,v)=>s+v.requests_waiting,0);

    html += `<div class="glass rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full bg-emerald-500 status-online"></div><h3 class="text-lg font-semibold text-white">${d.server_name}</h3></div>
        <div class="flex gap-4 text-xs">
          <span class="text-gray-400">Total: <span class="text-white font-semibold">${fmt(totalReqs)}</span> reqs</span>
          <span class="text-gray-400">Prompt: <span class="text-cyan-400 font-semibold">${(totalPrompt/1e6).toFixed(1)}M</span> tok</span>
          <span class="text-gray-400">Gen: <span class="text-purple-400 font-semibold">${(totalGen/1e6).toFixed(1)}M</span> tok</span>
          <span class="text-gray-400">Active: <span class="text-emerald-400 font-semibold">${totalRunning}</span></span>
          <span class="text-gray-400">Queued: <span class="${totalWaiting>0?'text-amber-400':'text-gray-500'} font-semibold">${totalWaiting}</span></span>
        </div>
      </div>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">${vllm.map(v=>renderVllmService(v)).join('')}</div>
    </div>`;
  }
  if (!html) html = '<div class="text-gray-500 text-center py-12">Loading traffic data...</div>';
  el.innerHTML = html;
}

// ── History & Peaks Tab ──
function renderHistory() {
  const el = document.getElementById('page-history');
  let html = '';
  for (const key of SERVERS) {
    const h = historyData[key] || [];
    const d = serverData[key];
    if (!d || d.status === 'offline') continue;

    if (h.length < 2) {
      html += `<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white mb-2">${d.server_name}</h3><p class="text-gray-500 text-sm">Collecting data... (${h.length} samples so far)</p></div>`;
      continue;
    }

    const utils = h.map(p=>p.avg_util);
    const temps = h.map(p=>p.max_temp);
    const powers = h.map(p=>p.total_power);
    const running = h.map(p=>p.requests_running);
    const waiting = h.map(p=>p.requests_waiting);
    const connections = h.map(p=>p.active_connections||0);
    const hasConnections = connections.some(c=>c>0);

    // Peak analysis
    const peakUtil = Math.max(...utils);
    const peakUtilIdx = utils.indexOf(peakUtil);
    const peakUtilTime = new Date(h[peakUtilIdx].t * 1000).toLocaleTimeString();
    const peakTemp = Math.max(...temps);
    const peakPower = Math.max(...powers);
    const peakRunning = Math.max(...running);
    const peakRunIdx = running.indexOf(peakRunning);
    const peakRunTime = running.length > 0 ? new Date(h[peakRunIdx].t * 1000).toLocaleTimeString() : 'N/A';
    const peakWaiting = Math.max(...waiting);
    const peakConns = Math.max(...connections);
    const peakConnsIdx = connections.indexOf(peakConns);
    const peakConnsTime = peakConnsIdx >= 0 ? new Date(h[peakConnsIdx].t * 1000).toLocaleTimeString() : 'N/A';
    const currentConns = connections.length > 0 ? connections[connections.length-1] : 0;

    const avgUtil = (utils.reduce((a,b)=>a+b,0)/utils.length).toFixed(1);
    const avgTemp = (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1);
    const avgConns = connections.length > 0 ? (connections.reduce((a,b)=>a+b,0)/connections.length).toFixed(1) : '0';

    const duration = h.length > 1 ? ((h[h.length-1].t - h[0].t) / 60).toFixed(0) : 0;

    // Concurrent calls section (for RTX 5090 / AgentV2)
    let callsHTML = '';
    if (hasConnections) {
      callsHTML = `
      <div class="glass-bright rounded-xl p-4 mb-5">
        <div class="flex items-center gap-2 mb-3">
          <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
          <span class="text-sm font-semibold text-white">Concurrent Calls (AgentV2)</span>
          <span class="ml-auto text-xs px-2 py-0.5 rounded-full ${currentConns>0?'bg-emerald-500/20 text-emerald-400':'bg-gray-700/50 text-gray-500'}">${currentConns} active now</span>
        </div>
        <div class="grid grid-cols-3 gap-3 mb-3">
          <div class="bg-white/[0.02] rounded-lg p-3 text-center">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Peak Concurrent Calls</div>
            <div class="text-2xl font-bold text-cyan-400">${peakConns}</div>
            <div class="text-[10px] text-gray-500">at ${peakConnsTime}</div>
          </div>
          <div class="bg-white/[0.02] rounded-lg p-3 text-center">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Avg Concurrent Calls</div>
            <div class="text-2xl font-bold text-gray-300">${avgConns}</div>
            <div class="text-[10px] text-gray-500">over session</div>
          </div>
          <div class="bg-white/[0.02] rounded-lg p-3 text-center">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Current Active</div>
            <div class="text-2xl font-bold ${currentConns>0?'text-emerald-400':'text-gray-500'}">${currentConns}</div>
            <div class="text-[10px] text-gray-500">connections</div>
          </div>
        </div>
        <div class="text-xs text-gray-400 mb-1">Concurrent Calls Over Time</div>
        ${sparklineSVG(connections, 600, 50, '#06b6d4')}
      </div>`;
    }

    html += `<div class="glass rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">${d.server_name}</h3>
        <span class="text-xs text-gray-500">${h.length} samples over ${duration} min</span>
      </div>

      ${callsHTML}

      <!-- Peak Cards -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-5">
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Peak GPU Util</div>
          <div class="text-xl font-bold ${getUtilColor(peakUtil).text}">${peakUtil}%</div>
          <div class="text-[10px] text-gray-500">at ${peakUtilTime}</div>
          <div class="mt-1">${sparklineSVG(utils.slice(-60), 80, 20, getUtilColor(peakUtil).ring)}</div>
        </div>
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Avg GPU Util</div>
          <div class="text-xl font-bold ${getUtilColor(parseFloat(avgUtil)).text}">${avgUtil}%</div>
          <div class="text-[10px] text-gray-500">over session</div>
        </div>
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Peak Temp</div>
          <div class="text-xl font-bold ${getTempColor(peakTemp).text}">${peakTemp}°C</div>
          <div class="text-[10px] text-gray-500">avg ${avgTemp}°C</div>
          <div class="mt-1">${sparklineSVG(temps.slice(-60), 80, 20, getTempColor(peakTemp).ring)}</div>
        </div>
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Peak Power</div>
          <div class="text-xl font-bold text-amber-400">${peakPower.toFixed(0)}W</div>
          <div class="text-[10px] text-gray-500">cluster total</div>
          <div class="mt-1">${sparklineSVG(powers.slice(-60), 80, 20, '#f59e0b')}</div>
        </div>
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Peak vLLM Active</div>
          <div class="text-xl font-bold text-cyan-400">${peakRunning}</div>
          <div class="text-[10px] text-gray-500">at ${peakRunTime}</div>
          <div class="mt-1">${sparklineSVG(running.slice(-60), 80, 20, '#06b6d4')}</div>
        </div>
        <div class="glass-bright rounded-lg p-3">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Peak Queued</div>
          <div class="text-xl font-bold ${peakWaiting>0?'text-amber-400':'text-gray-500'}">${peakWaiting}</div>
          <div class="text-[10px] text-gray-500">max waiting</div>
          <div class="mt-1">${sparklineSVG(waiting.slice(-60), 80, 20, '#f59e0b')}</div>
        </div>
      </div>

      <!-- Sparkline Charts -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass-bright rounded-xl p-4">
          <div class="text-xs text-gray-400 mb-2">GPU Utilization Over Time</div>
          ${sparklineSVG(utils, 400, 60, '#22c55e')}
        </div>
        <div class="glass-bright rounded-xl p-4">
          <div class="text-xs text-gray-400 mb-2">${hasConnections ? 'Concurrent Calls Over Time' : 'Active Requests Over Time'}</div>
          ${sparklineSVG(hasConnections ? connections : running, 400, 60, '#06b6d4')}
        </div>
        <div class="glass-bright rounded-xl p-4">
          <div class="text-xs text-gray-400 mb-2">Temperature Over Time</div>
          ${sparklineSVG(temps, 400, 60, '#ef4444')}
        </div>
        <div class="glass-bright rounded-xl p-4">
          <div class="text-xs text-gray-400 mb-2">Power Draw Over Time</div>
          ${sparklineSVG(powers, 400, 60, '#f59e0b')}
        </div>
      </div>
    </div>`;
  }
  if (!html) html = '<div class="text-gray-500 text-center py-12">Loading history data...</div>';
  el.innerHTML = html;
}

// ── Software & Tools Tab ──
async function checkPyPI(pkgName) {
  const normalized = pkgName.toLowerCase().replace(/_/g, '-');
  if (pypiCache[normalized]) return pypiCache[normalized];
  try {
    const r = await fetch(`https://pypi.org/pypi/${normalized}/json`);
    if (!r.ok) return null;
    const d = await r.json();
    const latest = d.info.version;
    const summary = d.info.summary || '';
    const projectUrl = d.info.project_url || d.info.package_url || '';
    const releaseUrl = `https://pypi.org/project/${normalized}/${latest}/`;
    pypiCache[normalized] = { latest, summary, releaseUrl };
    return pypiCache[normalized];
  } catch(e) { return null; }
}

function versionCompare(a, b) {
  const pa = a.replace(/[^0-9.]/g,'').split('.').map(Number);
  const pb = b.replace(/[^0-9.]/g,'').split('.').map(Number);
  for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
    const na = pa[i]||0, nb = pb[i]||0;
    if (na < nb) return -1;
    if (na > nb) return 1;
  }
  return 0;
}

async function loadSoftware() {
  const el = document.getElementById('page-software');
  el.innerHTML = '<div class="text-gray-500 text-center py-12"><div class="shimmer inline-block w-48 h-4 rounded mb-2"></div><div class="text-sm mt-2">Loading software inventory...</div></div>';
  const [h200, rtx] = await Promise.all([
    fetch('/api/gpu?server=h200&endpoint=software').then(r=>r.json()).catch(()=>null),
    fetch('/api/gpu?server=rtx5090&endpoint=software').then(r=>r.json()).catch(()=>null),
  ]);
  softwareData.h200 = h200;
  softwareData.rtx5090 = rtx;
  softwareLoaded = true;
  renderSoftware();
}

async function checkAllUpdates(serverKey) {
  const sw = softwareData[serverKey];
  if (!sw || !sw.environments) return;
  for (const [envName, pkgs] of Object.entries(sw.environments)) {
    for (const pkg of pkgs) {
      const info = await checkPyPI(pkg.name);
      if (info) {
        pkg._latest = info.latest;
        pkg._releaseUrl = info.releaseUrl;
        pkg._hasUpdate = versionCompare(pkg.version, info.latest) < 0;
      }
    }
  }
  renderSoftware();
}

function renderSoftwareServer(key, sw) {
  if (!sw || sw.error) {
    return `<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white">${key}</h3><p class="text-red-400 text-sm mt-2">${sw?.error||'Failed to load'}</p></div>`;
  }

  let sysHTML = `<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
    <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">NVIDIA Driver</div><div class="text-sm font-semibold text-white">${sw.driver}</div></div>
    <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">CUDA</div><div class="text-sm font-semibold text-white">${sw.cuda||'N/A'}</div></div>
    <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Kernel</div><div class="text-sm font-semibold text-white">${sw.kernel}</div></div>
    <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Python</div><div class="text-sm font-semibold text-white">${sw.python}</div></div>
  </div>`;

  // Services
  let svcHTML = '';
  if (sw.services && sw.services.length > 0) {
    svcHTML = `<div class="mb-4"><div class="text-xs text-gray-400 mb-2 font-medium">Running Services</div><div class="flex flex-wrap gap-2">${sw.services.map(s=>`<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>${s.name}</span>`).join('')}</div></div>`;
  }

  // Environments
  let envHTML = '';
  for (const [envName, pkgs] of Object.entries(sw.environments || {})) {
    const hasAnyUpdate = pkgs.some(p => p._hasUpdate);
    const checkedUpdates = pkgs.some(p => p._latest !== undefined);
    envHTML += `<div class="glass-bright rounded-xl p-4 mb-3">
      <div class="flex items-center justify-between mb-3">
        <div class="text-sm font-medium text-white">${envName}</div>
        <div class="flex items-center gap-2">
          ${hasAnyUpdate ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400">${pkgs.filter(p=>p._hasUpdate).length} updates available</span>` : ''}
          <span class="text-[10px] text-gray-500">${pkgs.length} packages</span>
        </div>
      </div>
      <table class="w-full text-xs">
        <thead><tr class="text-gray-500 border-b border-gray-700/50">
          <th class="text-left py-1.5 font-medium">Package</th>
          <th class="text-left py-1.5 font-medium">Installed</th>
          <th class="text-left py-1.5 font-medium">Latest</th>
          <th class="text-right py-1.5 font-medium">Actions</th>
        </tr></thead>
        <tbody>${pkgs.map(p => {
          const hasUpdate = p._hasUpdate;
          const latest = p._latest || (checkedUpdates ? p.version : '-');
          const rowClass = hasUpdate ? 'bg-amber-500/5' : '';
          return `<tr class="${rowClass} border-b border-gray-800/30 hover:bg-white/[0.02]">
            <td class="py-1.5 text-gray-300 font-medium">${p.name}</td>
            <td class="py-1.5 ${hasUpdate?'text-amber-400':'text-gray-400'}">${p.version}</td>
            <td class="py-1.5 ${hasUpdate?'text-emerald-400':'text-gray-500'}">${latest}</td>
            <td class="py-1.5 text-right">
              ${p._releaseUrl ? `<a href="${p._releaseUrl}" target="_blank" title="Release notes" class="inline-flex items-center justify-center w-6 h-6 rounded hover:bg-white/10 text-gray-500 hover:text-blue-400"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></a>` : ''}
              ${hasUpdate ? `<span title="Update available — run: pip install ${p.name}==${p._latest}" class="inline-flex items-center justify-center w-6 h-6 rounded hover:bg-white/10 text-amber-400 hover:text-amber-300 cursor-pointer"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></span>` : ''}
            </td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>`;
  }

  return `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-white">${sw.server_name}</h3>
      <button onclick="checkAllUpdates('${key}')" class="text-xs px-3 py-1.5 rounded-lg bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20 transition-colors">Check for Updates</button>
    </div>
    ${sysHTML}${svcHTML}${envHTML}
  </div>`;
}

function renderSoftware() {
  const el = document.getElementById('page-software');
  if (!softwareLoaded) {
    el.innerHTML = '<div class="text-gray-500 text-center py-12">Click the Software & Tools tab to load inventory</div>';
    return;
  }
  el.innerHTML = SERVERS.map(k => renderSoftwareServer(k, softwareData[k])).join('');
}

// ── 24h Report Tab ──
async function loadDaily() {
  const el = document.getElementById('page-daily');
  el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading 24h report...</div>';
  const [h200, rtx] = await Promise.all([
    fetch('/api/gpu?server=h200&endpoint=daily').then(r=>r.json()).catch(()=>null),
    fetch('/api/gpu?server=rtx5090&endpoint=daily').then(r=>r.json()).catch(()=>null),
  ]);
  dailyData.h200 = h200;
  dailyData.rtx5090 = rtx;
  dailyLoaded = true;
  renderDaily();
}

function fmtTime(ts) { return new Date(ts*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function fmtTok(n) { if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); }

function renderDailyServer(key, dd) {
  if (!dd || dd.error || !dd.hours) {
    return `<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white">${dd?.server_name||key}</h3><p class="text-gray-500 text-sm mt-2">${dd?.error||'No data yet — collecting hourly stats'}</p></div>`;
  }

  const hours = dd.hours;
  if (hours.length === 0) {
    return `<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white">${dd.server_name}</h3><p class="text-gray-500 text-sm mt-2">No hourly data collected yet. Data populates as the dashboard runs.</p></div>`;
  }

  const padded = hours.slice(-24);
  const mid = Math.ceil(padded.length / 2);
  const left = padded.slice(0, mid);
  const right = padded.slice(mid);
  const gpuCount = padded[0]?.gpu_count || 8;

  // Summary stats across all hours
  const allMaxCalls = Math.max(...hours.map(h=>h.max_calls), 0);
  const allMaxGpuSum = Math.max(...hours.map(h=>h.max_gpu_util_sum), 0);
  const allMaxTemp = Math.max(...hours.map(h=>h.max_temp), 0);
  const allMaxPower = Math.max(...hours.map(h=>h.max_power), 0);
  const totalHourReqs = hours.reduce((s,h)=>s+h.hour_requests, 0);
  const totalPromptTok = hours.reduce((s,h)=>s+h.hour_prompt_tokens, 0);
  const totalGenTok = hours.reduce((s,h)=>s+h.hour_gen_tokens, 0);
  const totalNetRx = hours.reduce((s,h)=>s+h.hour_net_rx, 0);
  const totalNetTx = hours.reduce((s,h)=>s+h.hour_net_tx, 0);
  const peakCallsHour = hours.reduce((best, h) => h.max_calls > (best?.max_calls||0) ? h : best, hours[0]);
  const peakGpuHour = hours.reduce((best, h) => h.max_gpu_util_sum > (best?.max_gpu_util_sum||0) ? h : best, hours[0]);

  // Sparkline data
  const callsSpark = padded.map(h=>h.max_calls);
  const gpuSpark = padded.map(h=>h.max_gpu_util_sum);
  const tempSpark = padded.map(h=>h.max_temp);
  const powerSpark = padded.map(h=>h.max_power);
  const reqsSpark = padded.map(h=>h.hour_requests);

  function hourRow(h) {
    const gpuPct = gpuCount > 0 ? Math.round(h.max_gpu_util_sum / gpuCount) : h.max_gpu_util_avg;
    const utilColor = gpuPct >= 85 ? 'text-red-400' : gpuPct >= 50 ? 'text-amber-400' : 'text-emerald-400';
    const callsColor = h.max_calls > 0 ? 'text-cyan-400' : 'text-gray-500';
    const callsBar = allMaxCalls > 0 ? (h.max_calls / allMaxCalls * 100) : 0;
    const gpuBar = Math.min(gpuPct, 100);
    return `<tr class="border-b border-gray-800/30 hover:bg-white/[0.03]">
      <td class="py-1.5 px-2 text-gray-300 font-mono text-[11px]">${h.hour_label}</td>
      <td class="py-1.5 px-2">
        <div class="flex items-center gap-1.5">
          <span class="${callsColor} font-semibold text-[11px] w-6 text-right">${h.max_calls}</span>
          <div class="bar-track rounded-full h-1 flex-1"><div class="bar-fill rounded-full h-1" style="width:${callsBar}%;background:#06b6d4"></div></div>
        </div>
      </td>
      <td class="py-1.5 px-2">
        <div class="flex items-center gap-1.5">
          <span class="${utilColor} font-semibold text-[11px] w-14 text-right">${h.max_gpu_util_sum}%<span class="text-gray-600 font-normal"> (${gpuPct})</span></span>
          <div class="bar-track rounded-full h-1 flex-1"><div class="bar-fill rounded-full h-1" style="width:${gpuBar}%;background:${gpuPct>=85?'#ef4444':gpuPct>=50?'#f59e0b':'#22c55e'}"></div></div>
        </div>
      </td>
      <td class="py-1.5 px-2 text-center text-[11px] text-gray-300">${h.calls_at_max_gpu}</td>
      <td class="py-1.5 px-2 text-center text-[11px] ${h.max_temp>=80?'text-red-400':h.max_temp>=60?'text-amber-400':'text-gray-400'}">${h.max_temp}°</td>
      <td class="py-1.5 px-2 text-right text-[11px] text-gray-400">${h.max_power>0?h.max_power.toFixed(0)+'W':'-'}</td>
      <td class="py-1.5 px-2 text-right text-[11px] text-gray-400">${h.hour_requests>0?fmt(h.hour_requests):'-'}</td>
    </tr>`;
  }

  function halfTable(rows, label) {
    if (rows.length === 0) return `<div class="flex-1 glass-bright rounded-xl p-4"><div class="text-xs text-gray-500 text-center py-8">No data</div></div>`;
    return `<div class="flex-1 glass-bright rounded-xl p-3 overflow-x-auto">
      <div class="text-xs text-gray-400 mb-2 font-medium">${label}</div>
      <table class="w-full text-xs">
        <thead><tr class="text-gray-500 border-b border-gray-700/50">
          <th class="text-left py-1 px-2 font-medium text-[10px]">Hour</th>
          <th class="text-left py-1 px-2 font-medium text-[10px]">Peak Calls</th>
          <th class="text-left py-1 px-2 font-medium text-[10px]">GPU Sum% (avg)</th>
          <th class="text-center py-1 px-2 font-medium text-[10px]">Calls@GPU</th>
          <th class="text-center py-1 px-2 font-medium text-[10px]">Temp</th>
          <th class="text-right py-1 px-2 font-medium text-[10px]">Power</th>
          <th class="text-right py-1 px-2 font-medium text-[10px]">Reqs</th>
        </tr></thead>
        <tbody>${rows.map(hourRow).join('')}</tbody>
      </table>
    </div>`;
  }

  const firstHour = padded[0]?.hour_label || '?';
  const lastHour = padded[padded.length-1]?.hour_label || '?';

  return `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <h3 class="text-lg font-semibold text-white">${dd.server_name}</h3>
        <span class="text-xs text-gray-500">${firstHour} — ${lastHour} UTC &middot; ${padded.length}h &middot; ${gpuCount} GPUs</span>
      </div>
      <button onclick="loadDaily()" class="text-xs px-3 py-1.5 rounded-lg bg-white/[0.05] text-gray-400 border border-gray-700 hover:bg-white/10 transition-colors">Refresh</button>
    </div>

    <!-- Summary KPIs -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 mb-5">
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Peak Calls</div>
        <div class="text-lg font-bold text-cyan-400">${allMaxCalls}</div>
        <div class="text-[9px] text-gray-500">${peakCallsHour?.hour_label||'?'} UTC</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Peak GPU Sum</div>
        <div class="text-lg font-bold ${allMaxGpuSum/gpuCount>=85?'text-red-400':allMaxGpuSum/gpuCount>=50?'text-amber-400':'text-emerald-400'}">${allMaxGpuSum}%</div>
        <div class="text-[9px] text-gray-500">avg ${Math.round(allMaxGpuSum/gpuCount)}% per GPU</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Busiest Hour</div>
        <div class="text-lg font-bold text-white">${peakCallsHour?.hour_label||'—'}</div>
        <div class="text-[9px] text-gray-500">${peakCallsHour?.max_calls||0} calls</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Peak Temp</div>
        <div class="text-lg font-bold ${allMaxTemp>=80?'text-red-400':allMaxTemp>=60?'text-amber-400':'text-emerald-400'}">${allMaxTemp}°C</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Peak Power</div>
        <div class="text-lg font-bold text-amber-400">${allMaxPower.toFixed(0)}W</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Total Requests</div>
        <div class="text-lg font-bold text-white">${fmtTok(totalHourReqs)}</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Tokens In/Out</div>
        <div class="text-sm font-bold text-purple-400">${fmtTok(totalPromptTok)}/${fmtTok(totalGenTok)}</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Network I/O</div>
        <div class="text-sm font-bold text-gray-300">${formatBytes(totalNetRx)}/${formatBytes(totalNetTx)}</div>
      </div>
    </div>

    <!-- Sparkline trends -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-5">
      <div class="glass-bright rounded-lg p-3">
        <div class="text-[10px] text-gray-500 mb-1">Calls per Hour</div>
        ${sparklineSVG(callsSpark, 140, 30, '#06b6d4')}
      </div>
      <div class="glass-bright rounded-lg p-3">
        <div class="text-[10px] text-gray-500 mb-1">GPU Sum% per Hour</div>
        ${sparklineSVG(gpuSpark, 140, 30, '#22c55e')}
      </div>
      <div class="glass-bright rounded-lg p-3">
        <div class="text-[10px] text-gray-500 mb-1">Temp per Hour</div>
        ${sparklineSVG(tempSpark, 140, 30, '#ef4444')}
      </div>
      <div class="glass-bright rounded-lg p-3">
        <div class="text-[10px] text-gray-500 mb-1">Power per Hour</div>
        ${sparklineSVG(powerSpark, 140, 30, '#f59e0b')}
      </div>
      <div class="glass-bright rounded-lg p-3">
        <div class="text-[10px] text-gray-500 mb-1">Requests per Hour</div>
        ${sparklineSVG(reqsSpark, 140, 30, '#8b5cf6')}
      </div>
    </div>

    <!-- Two-column hourly breakdown -->
    <div class="flex gap-4">
      ${halfTable(left, left.length > 0 ? left[0].hour_label + ' — ' + left[left.length-1].hour_label + ' UTC' : 'Earlier')}
      ${halfTable(right, right.length > 0 ? right[0].hour_label + ' — ' + right[right.length-1].hour_label + ' UTC' : 'Later')}
    </div>
  </div>`;
}

function renderDaily() {
  const el = document.getElementById('page-daily');
  if (!dailyLoaded) {
    el.innerHTML = '<div class="text-gray-500 text-center py-12">Click 24h Report tab to load data</div>';
    return;
  }
  el.innerHTML = SERVERS.map(k => renderDailyServer(k, dailyData[k])).join('');
}

// ── Agent Tab ──
async function loadAgent() {
  const el = document.getElementById('page-agent');
  if (!agentData) el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading AgentV2 status...</div>';
  try {
    const r = await fetch('/api/gpu?endpoint=agent');
    agentData = await r.json();
  } catch(e) {
    agentData = { error: e.message };
  }
  renderAgent();
}

function renderAgent() {
  const el = document.getElementById('page-agent');
  const d = agentData;
  if (!d || d.error) {
    el.innerHTML = `<div class="glass rounded-2xl p-6"><h3 class="text-lg font-semibold text-white">AgentV2 Status</h3><p class="text-red-400 text-sm mt-2">${d?.error||'Failed to load'}</p></div>`;
    return;
  }

  const allUp = d.services?.every(s => s.status === 'active');
  const statusBadge = allUp
    ? '<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><span class="w-2 h-2 rounded-full bg-emerald-500 status-online"></span>All Services Running</span>'
    : '<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs bg-amber-500/10 text-amber-400 border border-amber-500/20"><span class="w-2 h-2 rounded-full bg-amber-500"></span>Some Services Down</span>';

  let kpiHTML = `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-5">
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Active Calls</div>
      <div class="text-2xl font-bold ${d.active_bots>0?'text-cyan-400':'text-gray-500'}">${d.active_bots}</div>
      <div class="text-[9px] text-gray-500">bot processes</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">TCP Connections</div>
      <div class="text-2xl font-bold ${d.tcp_connections>0?'text-emerald-400':'text-gray-500'}">${d.tcp_connections}</div>
      <div class="text-[9px] text-gray-500">port 8003</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Gunicorn Workers</div>
      <div class="text-2xl font-bold text-white">${d.gunicorn_workers}</div>
      <div class="text-[9px] text-gray-500">${d.gunicorn_memory_mb} MB RSS</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Voicemail Workers</div>
      <div class="text-2xl font-bold text-white">${d.voicemail_workers}</div>
      <div class="text-[9px] text-gray-500">classifier</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Health Watcher</div>
      <div class="text-2xl font-bold text-white">${d.health_checker_workers}</div>
      <div class="text-[9px] text-gray-500">${d.watched_pids} PIDs watched</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Failed Queue</div>
      <div class="text-2xl font-bold ${d.failed_reports_queue>0?'text-red-400':'text-emerald-400'}">${d.failed_reports_queue}</div>
      <div class="text-[9px] text-gray-500">pending retries</div>
    </div>
    <div class="glass-bright rounded-lg p-3 text-center">
      <div class="text-[9px] text-gray-500 uppercase mb-1">Zombies</div>
      <div class="text-2xl font-bold ${d.zombie_processes>0?'text-red-400':'text-emerald-400'}">${d.zombie_processes}</div>
      <div class="text-[9px] text-gray-500">defunct procs</div>
    </div>
  </div>`;

  let svcHTML = '<div class="glass-bright rounded-xl p-4 mb-5"><div class="text-xs text-gray-400 mb-3 font-medium">Services</div><div class="grid grid-cols-2 md:grid-cols-5 gap-2">';
  const roles = {"agentv2-main-server":"Call Router :8003","agentv2-voicemail-processor":"Intent Classifier :8001","agentv2-health-checker":"Process Monitor :9000","agentv2-failed-report":"Retry Queue :8006","agentv2-server-old":"Legacy Server"};
  for (const s of (d.services||[])) {
    const ok = s.status === 'active';
    svcHTML += `<div class="rounded-lg p-2.5 ${ok?'bg-emerald-500/5 border border-emerald-500/10':'bg-red-500/5 border border-red-500/10'}">
      <div class="flex items-center gap-1.5 mb-1"><span class="w-1.5 h-1.5 rounded-full ${ok?'bg-emerald-500':'bg-red-500'}"></span><span class="text-[11px] font-medium ${ok?'text-emerald-400':'text-red-400'}">${ok?'Active':'Down'}</span></div>
      <div class="text-[11px] text-white font-medium">${s.name.replace('agentv2-','')}</div>
      <div class="text-[9px] text-gray-500">${roles[s.name]||''}</div>
    </div>`;
  }
  svcHTML += '</div></div>';

  let extHTML = '<div class="glass-bright rounded-xl p-4 mb-5"><div class="text-xs text-gray-400 mb-3 font-medium">External Dependencies</div><div class="grid grid-cols-1 md:grid-cols-2 gap-2">';
  for (const dep of (d.external_deps||[])) {
    extHTML += `<div class="flex items-center justify-between rounded-lg p-2.5 ${dep.ok?'bg-emerald-500/5':'bg-red-500/5'} border ${dep.ok?'border-emerald-500/10':'border-red-500/10'}">
      <div><div class="text-[11px] text-white font-medium">${dep.name}</div><div class="text-[9px] text-gray-500 font-mono">${dep.host}</div></div>
      <span class="text-[10px] px-2 py-0.5 rounded-full ${dep.ok?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}">${dep.ok?'Reachable':'Unreachable'}</span>
    </div>`;
  }
  extHTML += '</div></div>';

  let botsHTML = '';
  if (d.bot_details && d.bot_details.length > 0) {
    botsHTML = `<div class="glass-bright rounded-xl p-4 mb-5">
      <div class="text-xs text-gray-400 mb-3 font-medium">Active Call Bots (${d.bot_details.length})</div>
      <table class="w-full text-xs"><thead><tr class="text-gray-500 border-b border-gray-700/50">
        <th class="text-left py-1.5 font-medium">PID</th><th class="text-left py-1.5 font-medium">Elapsed</th><th class="text-right py-1.5 font-medium">CPU%</th><th class="text-right py-1.5 font-medium">Memory</th><th class="text-left py-1.5 font-medium pl-4">Command</th>
      </tr></thead><tbody>${d.bot_details.map(b=>`<tr class="border-b border-gray-800/30">
        <td class="py-1.5 text-gray-300 font-mono">${b.pid}</td><td class="py-1.5 text-cyan-400">${b.elapsed}</td><td class="py-1.5 text-right text-gray-400">${b.cpu}%</td><td class="py-1.5 text-right text-gray-400">${(b.rss_kb/1024).toFixed(0)} MB</td><td class="py-1.5 text-gray-500 pl-4 truncate max-w-xs" title="${b.cmd}">${b.cmd}</td>
      </tr>`).join('')}</tbody></table>
    </div>`;
  }

  let gpuHTML = '';
  if (d.dcgm_gpus && d.dcgm_gpus.length > 0) {
    gpuHTML = `<div class="glass-bright rounded-xl p-4 mb-5">
      <div class="text-xs text-gray-400 mb-3 font-medium">GPU Telemetry (DCGM)</div>
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">${d.dcgm_gpus.map(g=>{
        const tc = g.temp>=60?'text-red-400':g.temp>=40?'text-amber-400':'text-emerald-400';
        return `<div class="rounded-lg p-2.5 bg-white/[0.02] border border-gray-800/50 text-center">
          <div class="text-[9px] text-gray-500 mb-1">GPU ${g.index}</div>
          <div class="text-sm font-semibold ${tc}">${g.temp}°C</div>
          <div class="text-[9px] text-gray-500">${g.power}W &middot; ${g.sm_clock}MHz</div>
          <div class="text-[9px] text-gray-500">${g.util}% util</div>
        </div>`;
      }).join('')}</div>
    </div>`;
  }

  let archHTML = `<div class="glass-bright rounded-xl p-4">
    <div class="text-xs text-gray-400 mb-3 font-medium">Architecture</div>
    <div class="text-[11px] text-gray-500 space-y-1.5">
      <div class="flex gap-2"><span class="text-gray-400 w-24">Call Flow:</span><span>Telnyx/WebRTC → <span class="text-white">:8003 Main Server</span> → Daily.co Room → Bot Process (per call)</span></div>
      <div class="flex gap-2"><span class="text-gray-400 w-24">LLM:</span><span>Bot → <span class="text-white">H200 vLLM :8001</span> (Qwen3-VL-8B-Instruct)</span></div>
      <div class="flex gap-2"><span class="text-gray-400 w-24">TTS:</span><span>Bot → <span class="text-white">H200 vLLM :8002</span> (recruite-tts-fp8)</span></div>
      <div class="flex gap-2"><span class="text-gray-400 w-24">STT:</span><span>Bot → <span class="text-white">External Whisper</span> (GLM-ASR-Nano)</span></div>
      <div class="flex gap-2"><span class="text-gray-400 w-24">Intent:</span><span>Bot → <span class="text-white">:8001 Voicemail Processor</span> (OpenRouter/Ministral-14B)</span></div>
      <div class="flex gap-2"><span class="text-gray-400 w-24">Webhooks:</span><span>Bot → Caller's webhook URL (call events, transcripts, summaries)</span></div>
    </div>
  </div>`;

  el.innerHTML = `<div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-5">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white">AgentV2 — Voice Call Agent</h3>
          <p class="text-[11px] text-gray-500">RTX 5090 Cluster &middot; 38.65.239.47</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        ${statusBadge}
        <button onclick="loadAgent()" class="text-xs px-3 py-1.5 rounded-lg bg-white/[0.05] text-gray-400 border border-gray-700 hover:bg-white/10 transition-colors">Refresh</button>
      </div>
    </div>
    ${kpiHTML}${svcHTML}${extHTML}${botsHTML}${gpuHTML}${archHTML}
  </div>`;
}

// ── Analytics & Cost Tab ──
async function loadAnalytics() {
  const el = document.getElementById('page-analytics');
  if (!analyticsData) el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading analytics...</div>';
  try {
    const r = await fetch('/api/gpu?endpoint=analytics');
    analyticsData = await r.json();
  } catch(e) {
    analyticsData = { error: e.message };
  }
  analyticsLoaded = true;
  renderAnalytics();
}

function renderAnalytics() {
  const el = document.getElementById('page-analytics');
  const d = analyticsData;
  if (!d || d.error) {
    el.innerHTML = `<div class="glass rounded-2xl p-6"><h3 class="text-lg font-semibold text-white">Analytics</h3><p class="text-red-400 text-sm mt-2">${d?.error||'Failed to load'}</p></div>`;
    return;
  }

  const c = d.cost || {};
  const cq = d.concurrency_quality || [];
  const bn = d.bottleneck || {};
  const hd = d.headroom || {};
  const al = d.alerts || [];
  const qs = d.quality_scorecard || {};
  const ef = d.efficiency || {};

  // ── Section 1: Cost Breakdown ──
  let costHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-5">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white">Cost Breakdown</h3>
          <p class="text-[11px] text-gray-500">${c.total_gpus} GPUs &middot; Based on ${c.data_hours}h of data</p>
        </div>
      </div>
      <button onclick="loadAnalytics()" class="text-xs px-3 py-1.5 rounded-lg bg-white/[0.05] text-gray-400 border border-gray-700 hover:bg-white/10 transition-colors">Refresh</button>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-4">
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Monthly Cost</div>
        <div class="text-xl font-bold text-white">$${fmt(c.monthly)}</div>
        <div class="text-[9px] text-gray-500">total GPU infra</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Daily Cost</div>
        <div class="text-xl font-bold text-white">$${c.daily?.toFixed(0)}</div>
        <div class="text-[9px] text-gray-500">per day</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Per GPU/Hour</div>
        <div class="text-xl font-bold text-cyan-400">$${c.per_gpu_hour}</div>
        <div class="text-[9px] text-gray-500">${c.total_gpus} GPUs</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Cost/Call/Min</div>
        <div class="text-xl font-bold ${c.per_call_minute>0?'text-emerald-400':'text-gray-500'}">$${c.per_call_minute?.toFixed(4)||'—'}</div>
        <div class="text-[9px] text-gray-500">avg ${c.avg_concurrent_calls} concurrent</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Cost/Call/Hour</div>
        <div class="text-xl font-bold ${c.per_call_hour>0?'text-emerald-400':'text-gray-500'}">$${c.per_call_hour?.toFixed(2)||'—'}</div>
        <div class="text-[9px] text-gray-500">per active call</div>
      </div>
      <div class="glass-bright rounded-lg p-3 text-center">
        <div class="text-[9px] text-gray-500 uppercase mb-1">Idle GPU Waste</div>
        <div class="text-xl font-bold text-red-400">$${c.idle_gpu_cost_hourly?.toFixed(2)}/hr</div>
        <div class="text-[9px] text-gray-500">${(100 - (c.avg_gpu_util||0)).toFixed(0)}% idle</div>
      </div>
    </div>
    <div class="glass-bright rounded-lg p-3">
      <div class="text-xs text-gray-400 mb-2">Cost Utilization</div>
      <div class="flex items-center gap-3">
        <div class="flex-1">
          <div class="bar-track rounded-full h-3 w-full flex overflow-hidden">
            <div class="h-3 rounded-l-full" style="width:${c.avg_gpu_util||0}%;background:#22c55e"></div>
            <div class="h-3 ${c.avg_gpu_util>=100?'':'rounded-r-full'}" style="width:${100-(c.avg_gpu_util||0)}%;background:rgba(239,68,68,0.3)"></div>
          </div>
        </div>
        <div class="flex gap-4 text-[10px]">
          <span class="text-emerald-400">Utilized: $${c.utilized_gpu_cost_hourly?.toFixed(2)}/hr</span>
          <span class="text-red-400">Idle: $${c.idle_gpu_cost_hourly?.toFixed(2)}/hr</span>
        </div>
      </div>
    </div>
  </div>`;

  // ── Section 2: Concurrency vs Quality ──
  let cqHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-white">Concurrency vs Quality</h3>
        <p class="text-[11px] text-gray-500">How latency changes as concurrent calls increase</p>
      </div>
    </div>`;

  if (cq.length === 0) {
    cqHTML += '<p class="text-gray-500 text-sm">Collecting data... Quality metrics will appear as calls are processed.</p>';
  } else {
    const sweetSpot = [...cq].reverse().find(r => r.avg_ttft_ms > 0 && r.avg_ttft_ms <= 300);
    const degradePoint = cq.find(r => r.avg_ttft_ms > 500 && r.concurrent_calls > 0);

    if (sweetSpot || degradePoint) {
      cqHTML += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        ${sweetSpot ? `<div class="glass-bright rounded-lg p-3 border-l-2 border-emerald-500">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Sweet Spot</div>
          <div class="text-lg font-bold text-emerald-400">${sweetSpot.concurrent_calls} concurrent calls</div>
          <div class="text-[11px] text-gray-400">TTFT stays under 300ms (avg ${sweetSpot.avg_ttft_ms}ms)</div>
        </div>` : ''}
        ${degradePoint ? `<div class="glass-bright rounded-lg p-3 border-l-2 border-red-500">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Degradation Point</div>
          <div class="text-lg font-bold text-red-400">${degradePoint.concurrent_calls} concurrent calls</div>
          <div class="text-[11px] text-gray-400">TTFT exceeds 500ms (avg ${degradePoint.avg_ttft_ms}ms)</div>
        </div>` : ''}
      </div>`;
    }

    const maxTTFT = Math.max(...cq.map(r=>r.avg_ttft_ms), 1);
    cqHTML += `<div class="glass-bright rounded-xl p-4 overflow-x-auto">
      <table class="w-full text-xs">
        <thead><tr class="text-gray-500 border-b border-gray-700/50">
          <th class="text-left py-1.5 px-2 font-medium">Concurrent Calls</th>
          <th class="text-left py-1.5 px-2 font-medium">TTFT (ms)</th>
          <th class="text-left py-1.5 px-2 font-medium">ITL (ms)</th>
          <th class="text-left py-1.5 px-2 font-medium">E2E (s)</th>
          <th class="text-left py-1.5 px-2 font-medium">Queue (s)</th>
          <th class="text-left py-1.5 px-2 font-medium">KV Cache %</th>
          <th class="text-left py-1.5 px-2 font-medium">GPU Util %</th>
          <th class="text-right py-1.5 px-2 font-medium">Samples</th>
        </tr></thead>
        <tbody>${cq.map(r => {
          const ttftColor = r.avg_ttft_ms > 500 ? 'text-red-400' : r.avg_ttft_ms > 300 ? 'text-amber-400' : 'text-emerald-400';
          const ttftBar = maxTTFT > 0 ? (r.avg_ttft_ms / maxTTFT * 100) : 0;
          return `<tr class="border-b border-gray-800/30 hover:bg-white/[0.03]">
            <td class="py-1.5 px-2 text-white font-semibold">${r.concurrent_calls}</td>
            <td class="py-1.5 px-2"><div class="flex items-center gap-2"><span class="${ttftColor} font-semibold">${r.avg_ttft_ms > 0 ? r.avg_ttft_ms.toFixed(0) : '—'}</span><div class="bar-track rounded-full h-1 w-16"><div class="bar-fill rounded-full h-1" style="width:${ttftBar}%;background:${r.avg_ttft_ms>500?'#ef4444':r.avg_ttft_ms>300?'#f59e0b':'#22c55e'}"></div></div></div></td>
            <td class="py-1.5 px-2 text-gray-400">${r.avg_itl_ms > 0 ? r.avg_itl_ms.toFixed(1) : '—'}</td>
            <td class="py-1.5 px-2 text-gray-400">${r.avg_e2e_s > 0 ? r.avg_e2e_s.toFixed(2) : '—'}</td>
            <td class="py-1.5 px-2 text-gray-400">${r.avg_queue_s > 0 ? r.avg_queue_s.toFixed(3) : '—'}</td>
            <td class="py-1.5 px-2 text-gray-400">${r.avg_kv_cache > 0 ? r.avg_kv_cache.toFixed(1) : '—'}</td>
            <td class="py-1.5 px-2 text-gray-400">${r.avg_gpu_util.toFixed(1)}</td>
            <td class="py-1.5 px-2 text-right text-gray-500">${r.samples}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>`;
  }
  cqHTML += '</div>';

  // ── Section 3: Bottleneck Analysis ──
  let bnHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-white">Bottleneck Analysis</h3>
        <p class="text-[11px] text-gray-500">Where time is spent in the inference pipeline (${bn.samples||0} samples)</p>
      </div>
    </div>`;

  if (bn.samples > 0) {
    const segs = [
      { label: 'LLM (TTFT)', pct: bn.llm_pct, color: '#06b6d4' },
      { label: 'TTS/Generation', pct: bn.tts_generation_pct, color: '#8b5cf6' },
      { label: 'Queue Wait', pct: bn.queue_pct, color: '#f59e0b' },
      { label: 'Other/Network', pct: bn.other_pct, color: '#6b7280' },
    ];
    bnHTML += `<div class="glass-bright rounded-lg p-4 mb-3">
      <div class="flex items-center gap-2 mb-3"><span class="text-xs text-gray-400">Primary bottleneck:</span><span class="text-sm font-semibold text-white">${bn.primary_bottleneck}</span></div>
      <div class="bar-track rounded-full h-6 w-full flex overflow-hidden mb-3">
        ${segs.map(s => `<div class="h-6 flex items-center justify-center" style="width:${s.pct}%;background:${s.color}" title="${s.label}: ${s.pct}%">${s.pct >= 10 ? `<span class="text-[9px] text-white font-medium">${s.pct}%</span>` : ''}</div>`).join('')}
      </div>
      <div class="flex flex-wrap gap-4">${segs.map(s => `<div class="flex items-center gap-1.5"><div class="w-2.5 h-2.5 rounded-sm" style="background:${s.color}"></div><span class="text-[11px] text-gray-400">${s.label}: <span class="text-white font-medium">${s.pct}%</span></span></div>`).join('')}</div>
    </div>`;
  } else {
    bnHTML += '<p class="text-gray-500 text-sm">Collecting latency data...</p>';
  }
  bnHTML += '</div>';

  // ── Section 4: GPU Headroom ──
  let hdHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      </div>
      <div>
        <h3 class="text-lg font-semibold text-white">GPU Headroom & Capacity Planning</h3>
        <p class="text-[11px] text-gray-500">How much more load can each cluster handle</p>
      </div>
    </div>
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">`;

  for (const [sk, h] of Object.entries(hd)) {
    if (h.status === 'no data') { hdHTML += `<div class="glass-bright rounded-xl p-4"><span class="text-gray-500 text-sm">${sk}: No data yet</span></div>`; continue; }
    const utilColor = h.avg_util >= 80 ? 'text-red-400' : h.avg_util >= 50 ? 'text-amber-400' : 'text-emerald-400';
    hdHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold text-white">${h.server_name}</span><span class="text-xs px-2 py-0.5 rounded-full ${h.scale_factor>=2?'bg-emerald-500/20 text-emerald-400':h.scale_factor>=1.3?'bg-amber-500/20 text-amber-400':'bg-red-500/20 text-red-400'}">${h.scale_factor}x headroom</span></div>
      <div class="grid grid-cols-3 gap-2 mb-3">
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Avg GPU</div><div class="text-base font-bold ${utilColor}">${h.avg_util}%</div><div class="text-[9px] text-gray-500">${h.util_headroom}% free</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">VRAM</div><div class="text-base font-bold text-white">${h.avg_vram_pct}%</div><div class="text-[9px] text-gray-500">${h.vram_headroom}% free</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">KV Cache</div><div class="text-base font-bold text-white">${h.avg_kv_cache}%</div><div class="text-[9px] text-gray-500">${h.kv_headroom.toFixed(0)}% free</div></div>
      </div>
      <div class="grid grid-cols-2 gap-2 mb-3">
        <div class="bg-white/[0.02] rounded-lg p-2"><div class="text-[9px] text-gray-500 uppercase mb-0.5">Current Calls</div><div class="flex items-baseline gap-1"><span class="text-base font-bold text-cyan-400">${h.avg_calls}</span><span class="text-[10px] text-gray-500">avg / ${h.peak_calls} peak</span></div></div>
        <div class="bg-white/[0.02] rounded-lg p-2"><div class="text-[9px] text-gray-500 uppercase mb-0.5">Est. Max Calls</div><div class="flex items-baseline gap-1"><span class="text-base font-bold text-emerald-400">${h.est_max_calls}</span><span class="text-[10px] text-gray-500">${h.util_per_call}% GPU/call</span></div></div>
      </div>
      <div class="text-[10px] text-gray-500">Limits: GPU → ${h.est_max_calls_gpu} calls &middot; KV Cache → ${h.est_max_calls_kv > 0 ? h.est_max_calls_kv : '∞'} calls</div>
    </div>`;
  }
  hdHTML += '</div></div>';

  // ── Section 5: Quality Scorecard ──
  let qsHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Call Quality Scorecard</h3><p class="text-[11px] text-gray-500">Latency percentiles from recent data</p></div>
    </div>`;

  const metrics = [
    { key: 'ttft', label: 'Time to First Token', unit: 'ms', warn: 300, crit: 600 },
    { key: 'itl', label: 'Inter-Token Latency', unit: 'ms', warn: 60, crit: 120 },
    { key: 'e2e', label: 'End-to-End Latency', unit: 's', warn: 3.0, crit: 6.0 },
    { key: 'queue', label: 'Queue Wait Time', unit: 's', warn: 0.5, crit: 2.0 },
  ];

  qsHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';
  for (const m of metrics) {
    const v = qs[m.key] || {};
    if (!v.samples) continue;
    const p95Color = v.p95 >= m.crit ? 'text-red-400' : v.p95 >= m.warn ? 'text-amber-400' : 'text-emerald-400';
    const avgColor = v.avg >= m.crit ? 'text-red-400' : v.avg >= m.warn ? 'text-amber-400' : 'text-emerald-400';
    qsHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="flex items-center justify-between mb-2"><span class="text-xs font-medium text-white">${m.label}</span><span class="text-[10px] text-gray-500">${v.samples} samples</span></div>
      <div class="grid grid-cols-4 gap-2">
        <div class="text-center"><div class="text-[9px] text-gray-500">Avg</div><div class="text-sm font-bold ${avgColor}">${v.avg}${m.unit}</div></div>
        <div class="text-center"><div class="text-[9px] text-gray-500">P50</div><div class="text-sm font-bold text-gray-300">${v.p50}${m.unit}</div></div>
        <div class="text-center"><div class="text-[9px] text-gray-500">P95</div><div class="text-sm font-bold ${p95Color}">${v.p95}${m.unit}</div></div>
        <div class="text-center"><div class="text-[9px] text-gray-500">P99</div><div class="text-sm font-bold text-gray-400">${v.p99}${m.unit}</div></div>
      </div>
      <div class="mt-2">${barHTML(v.avg, m.crit, v.avg >= m.crit ? '#ef4444' : v.avg >= m.warn ? '#f59e0b' : '#22c55e')}</div>
    </div>`;
  }
  if (qs.kv_cache?.samples) {
    const kv = qs.kv_cache;
    qsHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="flex items-center justify-between mb-2"><span class="text-xs font-medium text-white">KV Cache Usage</span><span class="text-[10px] text-gray-500">${kv.samples} samples</span></div>
      <div class="grid grid-cols-2 gap-2">
        <div class="text-center"><div class="text-[9px] text-gray-500">Avg</div><div class="text-sm font-bold text-white">${kv.avg}%</div></div>
        <div class="text-center"><div class="text-[9px] text-gray-500">Peak</div><div class="text-sm font-bold ${kv.peak>=90?'text-red-400':kv.peak>=75?'text-amber-400':'text-emerald-400'}">${kv.peak}%</div></div>
      </div>
      <div class="mt-2">${barHTML(kv.avg, 100, kv.avg >= 90 ? '#ef4444' : kv.avg >= 75 ? '#f59e0b' : '#22c55e')}</div>
    </div>`;
  }
  qsHTML += '</div></div>';

  // ── Section 6: Alerts ──
  let alHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Alerts & Thresholds</h3><p class="text-[11px] text-gray-500">Current threshold violations</p></div>
    </div>`;

  if (al.length === 0) {
    alHTML += '<div class="glass-bright rounded-lg p-4 text-center"><span class="text-emerald-400 text-sm font-medium">All metrics within normal thresholds</span></div>';
  } else {
    alHTML += '<div class="space-y-2">';
    for (const a of al) {
      const isCrit = a.level === 'critical';
      alHTML += `<div class="glass-bright rounded-lg p-3 flex items-center justify-between ${isCrit?'border-l-2 border-red-500':'border-l-2 border-amber-500'}">
        <div class="flex items-center gap-3"><span class="w-2 h-2 rounded-full ${isCrit?'bg-red-500':'bg-amber-500'}"></span><div><span class="text-xs font-medium text-white">${a.metric}</span><span class="text-[10px] text-gray-500 ml-2">${a.server}</span></div></div>
        <div class="flex items-center gap-3"><span class="text-sm font-bold ${isCrit?'text-red-400':'text-amber-400'}">${a.value}</span><span class="text-[10px] text-gray-500">threshold: ${a.threshold}</span><span class="text-[10px] px-2 py-0.5 rounded-full ${isCrit?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}">${a.level}</span></div>
      </div>`;
    }
    alHTML += '</div>';
  }
  alHTML += '</div>';

  // ── Section 7: Model Efficiency ──
  let efHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Model Efficiency</h3><p class="text-[11px] text-gray-500">Throughput and cost-per-token metrics</p></div>
    </div>
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">`;

  for (const [sk, e] of Object.entries(ef)) {
    efHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="text-sm font-semibold text-white mb-3">${e.server_name}</div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Tokens/sec</div><div class="text-base font-bold text-cyan-400">${e.tokens_per_sec}</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Reqs/min</div><div class="text-base font-bold text-white">${e.reqs_per_min}</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Tokens/Watt</div><div class="text-base font-bold text-emerald-400">${e.tokens_per_watt}</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">$/1M Tokens</div><div class="text-base font-bold text-amber-400">$${e.cost_per_million_tokens}</div></div>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-2">
        <div class="text-center text-[10px]"><span class="text-gray-500">Prompt:</span> <span class="text-gray-300">${(e.prompt_tokens_hour/1e3).toFixed(1)}K tok/hr</span></div>
        <div class="text-center text-[10px]"><span class="text-gray-500">Gen:</span> <span class="text-gray-300">${(e.gen_tokens_hour/1e3).toFixed(1)}K tok/hr</span></div>
        <div class="text-center text-[10px]"><span class="text-gray-500">Power:</span> <span class="text-gray-300">${e.avg_power_w}W avg</span></div>
      </div>
    </div>`;
  }
  if (Object.keys(ef).length === 0) {
    efHTML += '<div class="glass-bright rounded-xl p-4 text-gray-500 text-sm col-span-2">Collecting throughput data...</div>';
  }
  efHTML += '</div></div>';

  el.innerHTML = costHTML + cqHTML + bnHTML + hdHTML + qsHTML + alHTML + efHTML;
}

// ── Proactive Alerts & Ops Tab ──
async function loadProactive() {
  const el = document.getElementById('page-proactive');
  if (!proactiveData) el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading proactive alerts...</div>';
  try {
    const r = await fetch('/api/gpu?endpoint=proactive');
    proactiveData = await r.json();
  } catch(e) {
    proactiveData = { error: e.message };
  }
  renderProactive();
}

function renderProactive() {
  const el = document.getElementById('page-proactive');
  const d = proactiveData;
  if (!d || d.error) {
    el.innerHTML = `<div class="glass rounded-2xl p-6"><h3 class="text-lg font-semibold text-white">Proactive Alerts</h3><p class="text-red-400 text-sm mt-2">${d?.error||'Failed to load'}</p></div>`;
    return;
  }

  const pa = d.predictive_alerts || [];
  let paHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        </div>
        <div><h3 class="text-lg font-semibold text-white">Predictive Alerts</h3><p class="text-[11px] text-gray-500">Trend-based predictions — issues before they happen</p></div>
      </div>
      <button onclick="loadProactive()" class="text-xs px-3 py-1.5 rounded-lg bg-white/[0.05] text-gray-400 border border-gray-700 hover:bg-white/10 transition-colors">Refresh</button>
    </div>`;
  if (pa.length === 0) {
    paHTML += '<div class="glass-bright rounded-lg p-4 text-center"><span class="text-emerald-400 text-sm font-medium">No predicted issues — all trends look healthy</span></div>';
  } else {
    paHTML += '<div class="space-y-2">';
    for (const a of pa) {
      const isCrit = a.severity === 'critical';
      paHTML += `<div class="glass-bright rounded-lg p-3 ${isCrit?'border-l-2 border-red-500':'border-l-2 border-amber-500'}">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3"><span class="w-2 h-2 rounded-full ${isCrit?'bg-red-500 status-offline':'bg-amber-500'}"></span><div><span class="text-xs font-medium text-white">${a.metric}</span><span class="text-[10px] text-gray-500 ml-2">${a.server}</span></div></div>
          <div class="flex items-center gap-3">
            <span class="text-[10px] text-gray-400">Current: <span class="text-white font-medium">${a.current}</span></span>
            ${a.eta_hours > 0 ? `<span class="text-[10px] px-2 py-0.5 rounded-full ${isCrit?'bg-red-500/20 text-red-400':'bg-amber-500/20 text-amber-400'}">ETA: ${a.eta_hours < 1 ? (a.eta_hours*60).toFixed(0)+'m' : a.eta_hours.toFixed(1)+'h'}</span>` : ''}
          </div>
        </div>
        <div class="text-[11px] text-gray-400 mt-1.5 ml-5">${a.message}</div>
      </div>`;
    }
    paHTML += '</div>';
  }
  paHTML += '</div>';

  const er = d.error_rates || {};
  let erHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Error Rate Tracker</h3><p class="text-[11px] text-gray-500">vLLM request failures and error trends</p></div>
    </div><div class="grid grid-cols-1 xl:grid-cols-2 gap-4">`;
  for (const [sk, e] of Object.entries(er)) {
    const statusColor = e.status === 'critical' ? 'text-red-400' : e.status === 'warning' ? 'text-amber-400' : 'text-emerald-400';
    const statusBg = e.status === 'critical' ? 'bg-red-500/20' : e.status === 'warning' ? 'bg-amber-500/20' : 'bg-emerald-500/20';
    erHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold text-white">${e.server_name}</span><span class="text-[10px] px-2 py-0.5 rounded-full ${statusBg} ${statusColor}">${e.status}</span></div>
      <div class="grid grid-cols-3 gap-2 mb-3">
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Window Errors</div><div class="text-base font-bold ${e.window_errors>0?'text-red-400':'text-emerald-400'}">${e.window_errors}</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Window Rate</div><div class="text-base font-bold ${statusColor}">${e.window_rate}%</div></div>
        <div class="bg-white/[0.02] rounded-lg p-2 text-center"><div class="text-[9px] text-gray-500 uppercase">Total Requests</div><div class="text-base font-bold text-white">${fmt(e.total_requests)}</div></div>
      </div>
      <div class="text-[10px] text-gray-500 mb-1">Error count trend</div>
      ${sparklineSVG(e.sparkline || [], 200, 25, e.status === 'healthy' ? '#22c55e' : '#ef4444')}
    </div>`;
  }
  if (!Object.keys(er).length) erHTML += '<div class="glass-bright rounded-xl p-4 text-gray-500 text-sm col-span-2">Collecting error data...</div>';
  erHTML += '</div></div>';

  const ph = d.process_health || {};
  let phHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Process Health Monitor</h3><p class="text-[11px] text-gray-500">Zombies, memory leaks, worker counts (RTX 5090)</p></div>
    </div>`;
  if (ph.samples) {
    const zombieColor = ph.current_zombies >= 50 ? 'text-red-400' : ph.current_zombies >= 20 ? 'text-amber-400' : 'text-emerald-400';
    phHTML += `<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Zombies</div><div class="text-2xl font-bold ${zombieColor}">${ph.current_zombies}</div><div class="text-[9px] text-gray-500">defunct</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Gunicorn RSS</div><div class="text-2xl font-bold ${ph.rss_leak_detected?'text-red-400':'text-white'}">${(ph.gunicorn_rss_mb/1024).toFixed(1)}G</div><div class="text-[9px] ${ph.rss_leak_detected?'text-red-400':'text-gray-500'}">${ph.rss_leak_detected?'LEAK DETECTED':'stable'}</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Workers</div><div class="text-2xl font-bold text-white">${ph.gunicorn_workers}</div><div class="text-[9px] text-gray-500">gunicorn</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Active Bots</div><div class="text-2xl font-bold ${ph.active_bots>0?'text-cyan-400':'text-gray-500'}">${ph.active_bots}</div><div class="text-[9px] text-gray-500">calls</div></div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Zombie Trend</div>${sparklineSVG(ph.zombie_trend||[],140,30,ph.current_zombies>=50?'#ef4444':'#f59e0b')}</div>
      <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Memory Trend</div>${sparklineSVG(ph.rss_trend||[],140,30,ph.rss_leak_detected?'#ef4444':'#8b5cf6')}</div>
      <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Workers</div>${sparklineSVG(ph.worker_trend||[],140,30,'#22c55e')}</div>
      <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Bots</div>${sparklineSVG(ph.bot_trend||[],140,30,'#06b6d4')}</div>
    </div>`;
  } else phHTML += '<p class="text-gray-500 text-sm">Visit Agent tab first to start collecting process health data.</p>';
  phHTML += '</div>';

  const su = d.service_uptime || {};
  let suHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Service Uptime</h3><p class="text-[11px] text-gray-500">Availability and incident history</p></div>
    </div>`;
  if (Object.keys(su).length > 0) {
    suHTML += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">';
    for (const [name, s] of Object.entries(su)) {
      const ok = s.status === 'active';
      const uptimeColor = s.uptime_pct >= 99.9 ? 'text-emerald-400' : s.uptime_pct >= 99 ? 'text-amber-400' : 'text-red-400';
      suHTML += `<div class="glass-bright rounded-xl p-4">
        <div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full ${ok?'bg-emerald-500':'bg-red-500'}"></span><span class="text-xs font-medium text-white">${name.replace('agentv2-','')}</span></div><span class="text-[10px] px-2 py-0.5 rounded-full ${ok?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}">${ok?'UP':'DOWN'}</span></div>
        <div class="flex items-baseline gap-2 mb-2"><span class="text-xl font-bold ${uptimeColor}">${s.uptime_pct}%</span><span class="text-[10px] text-gray-500">uptime</span></div>
        <div class="text-[10px] text-gray-500">Last change: ${s.last_change_ago}</div>
        ${s.incidents?.length ? `<div class="mt-2 space-y-1">${s.incidents.slice(-3).map(i=>`<div class="text-[10px] text-gray-400 flex gap-2"><span class="${i.to==='active'?'text-emerald-400':'text-red-400'}">${i.from}→${i.to}</span><span class="text-gray-500">${i.time_ago}</span></div>`).join('')}</div>` : ''}
      </div>`;
    }
    suHTML += '</div>';
  } else suHTML += '<p class="text-gray-500 text-sm">Visit Agent tab first to start tracking uptime.</p>';
  suHTML += '</div>';

  const cl = d.cluster_latency || {};
  let clHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Inter-Cluster Latency</h3><p class="text-[11px] text-gray-500">RTX 5090 → H200 round-trip (LLM/TTS path)</p></div>
    </div>`;
  if (cl.current_rtt_ms) {
    const latColor = cl.status === 'critical' ? 'text-red-400' : cl.status === 'warning' ? 'text-amber-400' : 'text-emerald-400';
    clHTML += `<div class="grid grid-cols-4 gap-3 mb-4">
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Current RTT</div><div class="text-xl font-bold ${latColor}">${cl.current_rtt_ms}ms</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Average</div><div class="text-xl font-bold text-white">${cl.avg_rtt_ms}ms</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Min</div><div class="text-xl font-bold text-emerald-400">${cl.min_rtt_ms}ms</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[9px] text-gray-500 uppercase mb-1">Max</div><div class="text-xl font-bold ${cl.max_rtt_ms>1500?'text-red-400':'text-amber-400'}">${cl.max_rtt_ms}ms</div></div>
    </div>
    <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Latency Over Time</div>${sparklineSVG(cl.trend||[],400,40,cl.status==='healthy'?'#22c55e':'#f59e0b')}</div>`;
  } else clHTML += '<p class="text-gray-500 text-sm">Measuring inter-cluster latency on next refresh...</p>';
  clHTML += '</div>';

  const tt = d.thermal_throttling || {};
  let ttHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">GPU Thermal Throttling</h3><p class="text-[11px] text-gray-500">Detects performance reduction due to heat</p></div>
    </div>`;
  if (!Object.keys(tt).length) {
    ttHTML += '<div class="glass-bright rounded-lg p-4 text-center"><span class="text-emerald-400 text-sm font-medium">No thermal throttling detected</span></div>';
  } else {
    for (const [sk, t] of Object.entries(tt)) {
      ttHTML += `<div class="glass-bright rounded-xl p-4 mb-3">
        <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold text-white">${t.server_name}</span>${t.any_throttling?'<span class="text-[10px] px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">THROTTLING</span>':'<span class="text-[10px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400">HIGH TEMP</span>'}</div>
        <div class="grid grid-cols-4 md:grid-cols-8 gap-2">${t.gpus.map(g=>`<div class="rounded-lg p-2 text-center ${g.likely_throttling?'bg-red-500/10 border border-red-500/20':'bg-amber-500/5 border border-amber-500/10'}"><div class="text-[9px] text-gray-500">GPU ${g.gpu}</div><div class="text-sm font-bold ${g.current_temp>=83?'text-red-400':g.current_temp>=75?'text-amber-400':'text-emerald-400'}">${g.current_temp}°C</div><div class="text-[9px] text-gray-500">${g.power_drop_pct>0?'-'+g.power_drop_pct+'% pwr':'OK'}</div></div>`).join('')}</div>
      </div>`;
    }
  }
  ttHTML += '</div>';

  const cf = d.call_forecast || {};
  const hours = cf.hours || [];
  let cfHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-sky-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Call Volume Forecast</h3><p class="text-[11px] text-gray-500">${cf.day||''} — hourly call pattern</p></div>
    </div>`;
  if (hours.length > 0 && hours.some(h => h.avg_calls > 0)) {
    const maxAvg = Math.max(...hours.map(h => h.avg_calls), 1);
    const peakHour = cf.peak_hour;
    if (peakHour?.avg_calls > 0) cfHTML += `<div class="glass-bright rounded-lg p-3 mb-4 border-l-2 border-cyan-500"><div class="text-[10px] text-gray-500 uppercase mb-1">Expected Peak Hour</div><div class="text-lg font-bold text-cyan-400">${peakHour.label} UTC</div><div class="text-[11px] text-gray-400">Avg ${peakHour.avg_calls} calls &middot; Peak ${peakHour.peak_calls}</div></div>`;
    cfHTML += `<div class="glass-bright rounded-xl p-4 overflow-x-auto"><div class="flex items-end gap-1" style="height:100px">${hours.map(h=>{const pct=maxAvg>0?(h.avg_calls/maxAvg*100):0;const color=h.is_current?'#06b6d4':(h.avg_calls/maxAvg>0.8?'#f59e0b':'#22c55e');return `<div class="flex flex-col items-center flex-1 gap-0.5"><div class="w-full rounded-t" style="height:${Math.max(pct,2)}%;background:${color};min-height:2px" title="${h.label}: avg ${h.avg_calls}"></div><span class="text-[8px] text-gray-500 ${h.is_current?'text-cyan-400 font-bold':''}">${h.hour%3===0?h.label.replace(':00',''):''}</span></div>`;}).join('')}</div></div>`;
  } else cfHTML += '<p class="text-gray-500 text-sm">Building call volume patterns...</p>';
  cfHTML += '</div>';

  const dsk = d.disk_trends || {};
  let dtHTML = `<div class="glass rounded-2xl p-6 mb-6">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-gray-500 to-slate-600 flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>
      </div>
      <div><h3 class="text-lg font-semibold text-white">Disk & Log Growth</h3><p class="text-[11px] text-gray-500">Storage trends and fill-time estimates</p></div>
    </div><div class="grid grid-cols-1 xl:grid-cols-2 gap-4">`;
  for (const [sk, disk] of Object.entries(dsk)) {
    const diskColor = disk.status==='critical'?'text-red-400':disk.status==='warning'?'text-amber-400':'text-emerald-400';
    dtHTML += `<div class="glass-bright rounded-xl p-4">
      <div class="flex items-center justify-between mb-3"><span class="text-sm font-semibold text-white">${disk.server_name}</span><span class="text-[10px] px-2 py-0.5 rounded-full ${disk.status==='critical'?'bg-red-500/20 text-red-400':disk.status==='warning'?'bg-amber-500/20 text-amber-400':'bg-emerald-500/20 text-emerald-400'}">${disk.status}</span></div>
      <div class="flex items-baseline gap-2 mb-2"><span class="text-2xl font-bold ${diskColor}">${disk.current_pct}%</span><span class="text-[10px] text-gray-500">used</span></div>
      ${barHTML(disk.current_pct,100,disk.current_pct>=90?'#ef4444':disk.current_pct>=80?'#f59e0b':'#22c55e')}
      <div class="grid grid-cols-2 gap-2 mt-3">
        <div class="text-[10px]"><span class="text-gray-500">Growth:</span> <span class="text-gray-300">${disk.growth_rate_pct_per_day}%/day</span></div>
        <div class="text-[10px]"><span class="text-gray-500">Days until full:</span> <span class="${disk.days_until_full&&disk.days_until_full<7?'text-red-400':'text-gray-300'}">${disk.days_until_full?disk.days_until_full+'d':'∞'}</span></div>
      </div>
      ${disk.trend?.length>1?`<div class="mt-2"><div class="text-[10px] text-gray-500 mb-1">Usage trend</div>${sparklineSVG(disk.trend,200,25,disk.current_pct>=80?'#f59e0b':'#22c55e')}</div>`:''}
    </div>`;
  }
  if (!Object.keys(dsk).length) dtHTML += '<div class="glass-bright rounded-xl p-4 text-gray-500 text-sm col-span-2">Disk tracking starts after a few minutes.</div>';
  dtHTML += '</div></div>';

  el.innerHTML = paHTML + erHTML + phHTML + suHTML + clHTML + ttHTML + cfHTML + dtHTML;
}

// ── Capacity Planner Tab ──
async function loadCapacity() {
  try {
    const r = await fetch('/api/gpu?endpoint=capacity');
    capacityData = await r.json();
    renderCapacity();
  } catch(e) { console.error('Capacity load error:', e); }
}

function renderCapacity() {
  const el = document.getElementById('page-capacity');
  if (!capacityData) { el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading capacity data...</div>'; return; }
  const d = capacityData;

  // ── 1. What-If Simulator ──
  let wiHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">What-If Simulator</h3>';
  wiHTML += '<p class="text-xs text-gray-500 mb-4">Projected metrics at different concurrent call levels</p>';
  wiHTML += '<div class="overflow-x-auto"><table class="w-full text-xs">';
  wiHTML += '<thead><tr class="text-gray-500 border-b border-gray-800">';
  wiHTML += '<th class="text-left py-2 px-2">Calls</th><th class="text-right py-2 px-2">GPU Util</th><th class="text-right py-2 px-2">TTFT (ms)</th><th class="text-right py-2 px-2">E2E (s)</th><th class="text-right py-2 px-2">KV Cache</th><th class="text-right py-2 px-2">GPUs Needed</th><th class="text-center py-2 px-2">Quality</th><th class="text-center py-2 px-2">Feasible</th>';
  wiHTML += '</tr></thead><tbody>';
  for (const w of (d.what_if || [])) {
    const utilC = w.projected_gpu_util > 85 ? 'text-red-400' : w.projected_gpu_util > 60 ? 'text-amber-400' : 'text-emerald-400';
    const qC = w.quality === 'good' ? 'text-emerald-400' : w.quality === 'degraded' ? 'text-amber-400' : 'text-red-400';
    const fC = w.feasible ? 'text-emerald-400' : 'text-red-400';
    const ttftC = w.projected_ttft_ms > 600 ? 'text-red-400' : w.projected_ttft_ms > 300 ? 'text-amber-400' : 'text-emerald-400';
    const highlight = w.target_calls === Math.round(d.roi?.current_avg_calls || 0) ? 'bg-emerald-500/10' : '';
    wiHTML += `<tr class="border-b border-gray-800/50 ${highlight}">`;
    wiHTML += `<td class="py-2 px-2 text-white font-medium">${w.target_calls}</td>`;
    wiHTML += `<td class="py-2 px-2 text-right ${utilC}">${w.projected_gpu_util}%</td>`;
    wiHTML += `<td class="py-2 px-2 text-right ${ttftC}">${w.projected_ttft_ms.toFixed(0)}</td>`;
    wiHTML += `<td class="py-2 px-2 text-right text-gray-300">${w.projected_e2e_s.toFixed(2)}</td>`;
    wiHTML += `<td class="py-2 px-2 text-right text-gray-300">${w.projected_kv_cache}%</td>`;
    wiHTML += `<td class="py-2 px-2 text-right text-gray-300">${w.gpus_needed_for_80pct}</td>`;
    wiHTML += `<td class="py-2 px-2 text-center ${qC}">${w.quality}</td>`;
    wiHTML += `<td class="py-2 px-2 text-center ${fC}">${w.feasible ? 'Yes' : 'No'}</td>`;
    wiHTML += '</tr>';
  }
  wiHTML += '</tbody></table></div></div>';

  // ── 2. GPU ROI Calculator ──
  const roi = d.roi || {};
  let roiHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">GPU ROI Calculator</h3>';
  roiHTML += '<p class="text-xs text-gray-500 mb-4">Cost efficiency and break-even analysis</p>';
  roiHTML += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
  roiHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Monthly Cost</div><div class="text-lg font-bold text-white">$${(roi.monthly_cost||0).toLocaleString()}</div></div>`;
  roiHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Cost / Call-Min</div><div class="text-lg font-bold ${(roi.current_cost_per_call_min||0) > 0.10 ? 'text-red-400' : 'text-emerald-400'}">$${(roi.current_cost_per_call_min||0).toFixed(4)}</div></div>`;
  roiHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Idle Waste / Month</div><div class="text-lg font-bold text-amber-400">$${(roi.idle_waste_monthly||0).toLocaleString()}</div></div>`;
  roiHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 mb-1">Effective Utilization</div><div class="text-lg font-bold ${(roi.effective_util_pct||0) > 50 ? 'text-emerald-400' : 'text-amber-400'}">${roi.effective_util_pct||0}%</div></div>`;
  roiHTML += '</div>';
  roiHTML += '<div class="text-xs text-gray-400 mb-2 font-medium">Break-Even Analysis</div>';
  roiHTML += '<div class="overflow-x-auto"><table class="w-full text-xs">';
  roiHTML += '<thead><tr class="text-gray-500 border-b border-gray-800"><th class="text-left py-2 px-2">Target $/call-min</th><th class="text-right py-2 px-2">Min Concurrent Calls Needed</th></tr></thead><tbody>';
  for (const b of (roi.breakeven || [])) {
    const met = (roi.current_avg_calls || 0) >= b.min_concurrent_calls;
    roiHTML += `<tr class="border-b border-gray-800/50"><td class="py-1 px-2 text-white">$${b.target_cost_per_min}</td><td class="py-1 px-2 text-right ${met ? 'text-emerald-400' : 'text-gray-400'}">${b.min_concurrent_calls} ${met ? '&#10003;' : ''}</td></tr>`;
  }
  roiHTML += '</tbody></table></div></div>';

  // ── 3. Scale Recommendation ──
  const sr = d.scale_recommendation || {};
  const actionColor = sr.action === 'scale_up' ? 'text-red-400' : sr.action === 'scale_down' ? 'text-amber-400' : 'text-emerald-400';
  const actionBg = sr.action === 'scale_up' ? 'bg-red-500/10 border-red-500/30' : sr.action === 'scale_down' ? 'bg-amber-500/10 border-amber-500/30' : 'bg-emerald-500/10 border-emerald-500/30';
  let srHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">Scale Recommendation</h3>';
  srHTML += '<p class="text-xs text-gray-500 mb-4">Based on P95/P99 utilization patterns</p>';
  srHTML += `<div class="rounded-lg border p-4 mb-4 ${actionBg}">`;
  srHTML += `<div class="text-sm font-semibold ${actionColor} mb-1">${sr.action === 'scale_up' ? 'SCALE UP' : sr.action === 'scale_down' ? 'SCALE DOWN' : 'OPTIMAL'}</div>`;
  srHTML += `<div class="text-xs text-gray-300">${sr.detail || ''}</div>`;
  srHTML += '</div>';
  srHTML += '<div class="grid grid-cols-2 md:grid-cols-5 gap-3">';
  srHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500">Current GPUs</div><div class="text-white font-bold">${sr.current_gpus||0}</div></div>`;
  srHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500">P95 Util</div><div class="text-white font-bold">${sr.p95_util||0}%</div></div>`;
  srHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500">P99 Util</div><div class="text-white font-bold">${sr.p99_util||0}%</div></div>`;
  srHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500">Min GPUs (P95)</div><div class="text-white font-bold">${sr.min_gpus_for_p95||0}</div></div>`;
  srHTML += `<div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500">Savings if Downscale</div><div class="text-emerald-400 font-bold">$${(sr.monthly_savings_if_downscale||0).toLocaleString()}/mo</div></div>`;
  srHTML += '</div></div>';

  // ── 4. Cloud Cost Comparison ──
  let ccHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">Cloud Cost Comparison</h3>';
  ccHTML += `<p class="text-xs text-gray-500 mb-4">Your ${sr.current_gpus||16} GPUs at $${(roi.monthly_cost||25000).toLocaleString()}/mo vs cloud providers</p>`;
  ccHTML += '<div class="overflow-x-auto"><table class="w-full text-xs">';
  ccHTML += '<thead><tr class="text-gray-500 border-b border-gray-800">';
  ccHTML += '<th class="text-left py-2 px-2">Provider</th><th class="text-left py-2 px-2">GPU Config</th><th class="text-right py-2 px-2">$/hr (base)</th><th class="text-right py-2 px-2">$/mo (scaled)</th><th class="text-right py-2 px-2">You Save</th><th class="text-left py-2 px-2">Note</th>';
  ccHTML += '</tr></thead><tbody>';
  ccHTML += `<tr class="border-b border-gray-800/50 bg-emerald-500/10"><td class="py-2 px-2 text-emerald-400 font-semibold">Your Cluster</td><td class="py-2 px-2 text-gray-300">8x H200 + 8x RTX 5090</td><td class="py-2 px-2 text-right text-white">$${(roi.hourly_cost||0).toFixed(2)}</td><td class="py-2 px-2 text-right text-white font-bold">$${(roi.monthly_cost||0).toLocaleString()}</td><td class="py-2 px-2 text-right text-emerald-400">-</td><td class="py-2 px-2 text-gray-500">Dedicated</td></tr>`;
  for (const cp of (d.cloud_comparison || [])) {
    const saveC = cp.savings_vs_you > 0 ? 'text-emerald-400' : 'text-red-400';
    const saveTxt = cp.savings_vs_you > 0 ? `+$${cp.savings_vs_you.toLocaleString()}` : `-$${Math.abs(cp.savings_vs_you).toLocaleString()}`;
    ccHTML += `<tr class="border-b border-gray-800/50">`;
    ccHTML += `<td class="py-2 px-2 text-white">${cp.provider}</td>`;
    ccHTML += `<td class="py-2 px-2 text-gray-400">${cp.gpu}</td>`;
    ccHTML += `<td class="py-2 px-2 text-right text-gray-300">$${cp.hourly.toFixed(2)}</td>`;
    ccHTML += `<td class="py-2 px-2 text-right text-gray-300">$${cp.scaled_monthly.toLocaleString()}</td>`;
    ccHTML += `<td class="py-2 px-2 text-right ${saveC}">${saveTxt}</td>`;
    ccHTML += `<td class="py-2 px-2 text-gray-500">${cp.note}</td>`;
    ccHTML += '</tr>';
  }
  ccHTML += '</tbody></table></div></div>';

  el.innerHTML = wiHTML + roiHTML + srHTML + ccHTML;
}

// ── Render All ──
function renderAll() {
  if (activeTab === 'overview') renderOverview();
  else if (activeTab === 'traffic') renderTraffic();
  else if (activeTab === 'history') renderHistory();
  else if (activeTab === 'software') renderSoftware();
  else if (activeTab === 'daily') renderDaily();
  else if (activeTab === 'agent') renderAgent();
  else if (activeTab === 'analytics') renderAnalytics();
  else if (activeTab === 'proactive') renderProactive();
  else if (activeTab === 'capacity') renderCapacity();
  else if (activeTab === 'quality') renderQuality();
}

// ── Call Quality Deep Dive Tab ──
async function loadQuality() {
  try {
    const r = await fetch('/api/gpu?endpoint=quality');
    qualityData = await r.json();
    renderQuality();
  } catch(e) { console.error('Quality load error:', e); }
}

function renderQuality() {
  const el = document.getElementById('page-quality');
  if (!qualityData) { el.innerHTML = '<div class="text-gray-500 text-center py-12">Loading quality data...</div>'; return; }
  const d = qualityData;

  // ── 1. Pipeline Waterfall ──
  let wfHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">Pipeline Waterfall</h3>';
  wfHTML += '<p class="text-xs text-gray-500 mb-4">Call lifecycle breakdown: Queue → TTFT → Generation</p>';
  if ((d.waterfall||[]).length === 0) {
    wfHTML += '<div class="text-gray-500 text-sm">No waterfall data yet (needs vLLM metrics).</div>';
  } else {
    wfHTML += '<div class="space-y-1">';
    for (const w of d.waterfall.slice(-30)) {
      const time = new Date(w.t * 1000).toLocaleTimeString();
      const maxW = Math.max(w.total_s, 0.001);
      const qW = w.queue_s / maxW * 100;
      const tW = w.ttft_s / maxW * 100;
      const gW = w.generation_s / maxW * 100;
      wfHTML += `<div class="flex items-center gap-2 text-[10px]">`;
      wfHTML += `<span class="text-gray-500 w-16 flex-shrink-0">${time}</span>`;
      wfHTML += `<span class="text-gray-400 w-8 text-right">${w.calls}c</span>`;
      wfHTML += `<div class="flex-1 flex h-4 rounded overflow-hidden bg-gray-800">`;
      if (qW > 0.5) wfHTML += `<div style="width:${qW}%" class="bg-amber-500/60" title="Queue: ${w.queue_s.toFixed(3)}s"></div>`;
      if (tW > 0.5) wfHTML += `<div style="width:${tW}%" class="bg-cyan-500/60" title="TTFT: ${w.ttft_s.toFixed(3)}s"></div>`;
      if (gW > 0.5) wfHTML += `<div style="width:${gW}%" class="bg-purple-500/60" title="Gen: ${w.generation_s.toFixed(3)}s"></div>`;
      wfHTML += `</div>`;
      wfHTML += `<span class="text-gray-400 w-12 text-right">${w.total_s.toFixed(2)}s</span>`;
      wfHTML += `</div>`;
    }
    wfHTML += '</div>';
    wfHTML += '<div class="flex gap-4 mt-3 text-[10px]">';
    wfHTML += '<span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-500/60"></span> Queue</span>';
    wfHTML += '<span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-cyan-500/60"></span> TTFT</span>';
    wfHTML += '<span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-purple-500/60"></span> Generation</span>';
    wfHTML += '</div>';
  }
  wfHTML += '</div>';

  // ── 2. Quality Degradation Heatmap ──
  let hmHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">Quality Degradation Map</h3>';
  hmHTML += '<p class="text-xs text-gray-500 mb-4">TTFT by hour and GPU utilization — shows where quality drops</p>';
  const dmap = d.degradation_map || [];
  if (dmap.length === 0) {
    hmHTML += '<div class="text-gray-500 text-sm">No degradation data yet.</div>';
  } else {
    const hours = [...new Set(dmap.map(d=>d.hour))].sort((a,b)=>a-b);
    const buckets = [...new Set(dmap.map(d=>d.util_bucket))].sort((a,b)=>a-b);
    const lookup = {};
    let maxTtft = 1;
    for (const cell of dmap) {
      lookup[cell.hour+'_'+cell.util_bucket] = cell;
      if (cell.avg_ttft_ms > maxTtft) maxTtft = cell.avg_ttft_ms;
    }
    hmHTML += '<div class="overflow-x-auto"><table class="text-[10px]">';
    hmHTML += '<thead><tr><th class="px-1 py-1 text-gray-500">Util \\ Hour</th>';
    for (const h of hours) hmHTML += `<th class="px-1 py-1 text-gray-500 text-center">${String(h).padStart(2,'0')}</th>`;
    hmHTML += '</tr></thead><tbody>';
    for (const b of buckets) {
      hmHTML += `<tr><td class="px-1 py-1 text-gray-400 font-medium">${b}-${b+9}%</td>`;
      for (const h of hours) {
        const cell = lookup[h+'_'+b];
        if (cell && cell.avg_ttft_ms > 0) {
          const intensity = Math.min(cell.avg_ttft_ms / Math.max(maxTtft, 1), 1);
          const r = Math.round(intensity * 239);
          const g = Math.round((1-intensity) * 197);
          hmHTML += `<td class="px-1 py-1 text-center rounded" style="background:rgba(${r},${g},50,0.3)" title="${cell.avg_ttft_ms}ms TTFT, ${cell.samples} samples">${cell.avg_ttft_ms.toFixed(0)}</td>`;
        } else {
          hmHTML += '<td class="px-1 py-1 text-center text-gray-700">-</td>';
        }
      }
      hmHTML += '</tr>';
    }
    hmHTML += '</tbody></table></div>';
    hmHTML += '<div class="flex items-center gap-2 mt-2 text-[10px] text-gray-500"><span>Low TTFT</span><div class="w-24 h-2 rounded" style="background:linear-gradient(to right, rgba(50,197,50,0.3), rgba(239,50,50,0.3))"></div><span>High TTFT</span></div>';
  }
  hmHTML += '</div>';

  // ── 3. Latency Curve ──
  let lcHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">Concurrent Calls vs Latency</h3>';
  lcHTML += '<p class="text-xs text-gray-500 mb-4">Find the inflection point where quality degrades</p>';
  const curve = d.latency_curve || [];
  if (curve.length === 0) {
    lcHTML += '<div class="text-gray-500 text-sm">No latency curve data yet.</div>';
  } else {
    const maxE2E = Math.max(...curve.map(c=>c.avg_e2e_s), 0.001);
    lcHTML += '<div class="space-y-1">';
    for (const c of curve) {
      const barW = (c.avg_e2e_s / maxE2E * 100);
      const inflClass = c.inflection ? 'border-l-2 border-red-400 pl-2' : '';
      const barColor = c.avg_e2e_s > 6 ? 'bg-red-500/60' : c.avg_e2e_s > 3 ? 'bg-amber-500/60' : 'bg-emerald-500/60';
      lcHTML += `<div class="flex items-center gap-2 text-[11px] ${inflClass}">`;
      lcHTML += `<span class="text-gray-400 w-16 text-right">${c.concurrent_calls} calls</span>`;
      lcHTML += `<div class="flex-1 h-5 rounded bg-gray-800 relative overflow-hidden">`;
      lcHTML += `<div class="${barColor} h-full rounded" style="width:${barW}%"></div>`;
      lcHTML += `<span class="absolute inset-y-0 left-2 flex items-center text-white text-[10px]">${c.avg_e2e_s.toFixed(2)}s e2e &middot; ${c.avg_ttft_ms.toFixed(0)}ms ttft &middot; KV:${c.avg_kv_cache}%</span>`;
      lcHTML += `</div>`;
      lcHTML += `<span class="text-gray-500 w-12 text-right text-[10px]">${c.samples}s</span>`;
      if (c.inflection) lcHTML += '<span class="text-red-400 text-[10px] font-bold">INFLECTION</span>';
      lcHTML += '</div>';
    }
    lcHTML += '</div>';
  }
  lcHTML += '</div>';

  // ── 4. SLA Compliance ──
  let slaHTML = '<div class="glass rounded-xl p-6 mb-6"><h3 class="text-white font-semibold mb-1">SLA Compliance Tracker</h3>';
  slaHTML += '<p class="text-xs text-gray-500 mb-4">Track compliance against quality targets</p>';
  const sla = d.sla_compliance || {};
  if (Object.keys(sla).length === 0) {
    slaHTML += '<div class="text-gray-500 text-sm">No SLA data yet.</div>';
  } else {
    slaHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
    for (const [metric, s] of Object.entries(sla)) {
      const compC = s.compliance_pct >= 99 ? 'text-emerald-400' : s.compliance_pct >= 95 ? 'text-amber-400' : 'text-red-400';
      slaHTML += `<div class="glass-bright rounded-lg p-4">`;
      slaHTML += `<div class="flex justify-between items-center mb-2">`;
      slaHTML += `<span class="text-xs text-white font-medium">${s.label}</span>`;
      slaHTML += `<span class="text-lg font-bold ${compC}">${s.compliance_pct}%</span>`;
      slaHTML += '</div>';
      slaHTML += `<div class="h-2 rounded-full bg-gray-800 mb-2"><div class="h-2 rounded-full" style="width:${Math.min(s.compliance_pct,100)}%;background:${s.compliance_pct >= 99 ? '#22c55e' : s.compliance_pct >= 95 ? '#f59e0b' : '#ef4444'}"></div></div>`;
      slaHTML += `<div class="flex justify-between text-[10px] text-gray-500 mb-2">`;
      slaHTML += `<span>${s.total_samples} samples</span>`;
      slaHTML += `<span class="${s.violations > 0 ? 'text-red-400' : 'text-gray-500'}">${s.violations} violations</span>`;
      slaHTML += '</div>';
      if ((s.worst_hours||[]).length > 0) {
        slaHTML += '<div class="text-[10px] text-gray-500">Worst hours: ';
        slaHTML += s.worst_hours.map(h => `<span class="text-red-400">${h.hour}</span> (${h.violations})`).join(', ');
        slaHTML += '</div>';
      }
      slaHTML += '</div>';
    }
    slaHTML += '</div>';
  }
  slaHTML += '</div>';

  el.innerHTML = wfHTML + hmHTML + lcHTML + slaHTML;
}

// ── Data Fetching ──
async function fetchServer(key) {
  try { const r = await fetch('/api/gpu?server='+key); return await r.json(); }
  catch(e) { return { server_name: key, status:'offline', error: e.message }; }
}

async function fetchHistory(key) {
  try { const r = await fetch('/api/gpu?server='+key+'&endpoint=history'); const d = await r.json(); return d.history || []; }
  catch(e) { return []; }
}

async function refresh() {
  const [h200, rtx5090] = await Promise.all([fetchServer('h200'), fetchServer('rtx5090')]);
  serverData.h200 = h200;
  serverData.rtx5090 = rtx5090;

  // Fetch history less frequently
  if (!refresh._histCount) refresh._histCount = 0;
  if (refresh._histCount % 5 === 0) {
    const [hh, hr] = await Promise.all([fetchHistory('h200'), fetchHistory('rtx5090')]);
    historyData.h200 = hh;
    historyData.rtx5090 = hr;
  }
  refresh._histCount++;

  renderAll();
  document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

function updateRefreshRate() {
  refreshRate = parseInt(document.getElementById('refreshRate').value);
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(refresh, refreshRate);
}

// Init
renderOverview();
refresh();
refreshInterval = setInterval(refresh, refreshRate);
</script>
</body>
</html>