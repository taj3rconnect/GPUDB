<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  body { font-family: 'Inter', sans-serif; background: #0a0a0f; }
  .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(20px); }
  .glass-bright { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
  .ring-bg { stroke: rgba(255,255,255,0.06); }
  .ring-fill { transition: stroke-dashoffset 0.8s ease; stroke-linecap: round; }
  .bar-track { background: rgba(255,255,255,0.06); }
  .bar-fill { transition: width 0.8s ease; }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)} 50%{box-shadow:0 0 0 6px rgba(34,197,94,0)} }
  @keyframes pulse-red { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,68,68,0)} }
  .status-online { animation: pulse-green 2s infinite; }
  .status-offline { animation: pulse-red 2s infinite; }
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
  .shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
  .gpu-card:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-1px); }
  .gpu-card { transition: all 0.2s ease; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  .tab-active { border-bottom: 2px solid #22c55e; color: #fff; }
  .tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
  .tab-inactive:hover { color: #9ca3af; }
  .kpi-card { transition: all 0.2s ease; }
  .kpi-card:hover { background: rgba(255,255,255,0.06); }
</style>
<script>tailwind.config = { theme: { extend: { colors: { surface: { 50:'#0a0a0f', 100:'#111118', 200:'#1a1a24' } } } } }</script>
</head>
<body class="min-h-screen text-gray-200 p-4 md:p-6">

<!-- Header -->
<div class="max-w-[1900px] mx-auto mb-6">
  <div class="flex items-center justify-between flex-wrap gap-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>
      </div>
      <div>
        <h1 class="text-xl font-semibold text-white">GPU Admin Dashboard</h1>
        <p class="text-xs text-gray-500">Real-time monitoring &middot; Traffic &middot; KPIs</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-xs text-gray-500">
        Refresh: <select id="refreshRate" onchange="updateRefreshRate()" class="bg-surface-100 border border-gray-700 rounded px-2 py-1 text-gray-300 text-xs">
          <option value="5000">5s</option><option value="10000">10s</option><option value="30000" selected>30s</option><option value="60000">60s</option>
        </select>
      </div>
      <button onclick="clearHistory()" class="text-[10px] text-gray-600 hover:text-gray-400 px-2 py-1 rounded border border-gray-800 hover:border-gray-600">Clear History</button>
      <div id="lastUpdate" class="text-xs text-gray-500"></div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="max-w-[1900px] mx-auto mb-4 flex gap-6 border-b border-gray-800 pb-0">
  <button class="tab-active pb-2 text-sm font-medium px-1" onclick="switchTab('overview')" id="tab-overview">Overview</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('traffic')" id="tab-traffic">Traffic & KPIs</button>
  <button class="tab-inactive pb-2 text-sm font-medium px-1" onclick="switchTab('history')" id="tab-history">History & Peaks</button>
</div>

<!-- Content -->
<div class="max-w-[1900px] mx-auto">
  <div id="page-overview"></div>
  <div id="page-traffic" class="hidden"></div>
  <div id="page-history" class="hidden"></div>
</div>

<script>
const SERVERS = ['h200','rtx5090'];
let refreshInterval = null;
let refreshRate = 30000;
let serverData = {};
let prevNetData = {};
let activeTab = 'overview';
const MAX_HIST = 2880;

// ── LocalStorage History ──
function loadHistory(key) {
  try { return JSON.parse(localStorage.getItem('gpu_hist_'+key) || '[]'); } catch(e) { return []; }
}
function saveHistory(key, data) {
  try { localStorage.setItem('gpu_hist_'+key, JSON.stringify(data.slice(-MAX_HIST))); } catch(e) {}
}
function clearHistory() {
  SERVERS.forEach(k => localStorage.removeItem('gpu_hist_'+k));
  renderAll();
}

// ── Utilities ──
function fmt(n) { return n.toLocaleString(); }
function formatBytes(b) { if(!b) return '0 B'; const g=b/(1024**3); return g>=1024?(g/1024).toFixed(1)+' TiB':g.toFixed(1)+' GiB'; }
function formatMiB(m) { return m>=1024?(m/1024).toFixed(1)+' GiB':m+' MiB'; }
function formatUptime(s) { const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60); return d>0?d+'d '+h+'h '+m+'m':h>0?h+'h '+m+'m':m+'m'; }
function formatRate(bps) { if(bps>=1e9) return (bps/1e9).toFixed(1)+' Gbps'; if(bps>=1e6) return (bps/1e6).toFixed(1)+' Mbps'; if(bps>=1e3) return (bps/1e3).toFixed(1)+' Kbps'; return bps.toFixed(0)+' bps'; }
function getColor(v,t) { return v>=t[1]?{ring:'#ef4444',bg:'rgba(239,68,68,0.15)',text:'text-red-400'}:v>=t[0]?{ring:'#f59e0b',bg:'rgba(245,158,11,0.15)',text:'text-amber-400'}:{ring:'#22c55e',bg:'rgba(34,197,94,0.12)',text:'text-emerald-400'}; }
function getTempColor(t){return getColor(t,[60,80]);}
function getUtilColor(u){return getColor(u,[50,85]);}
function getPowerColor(p){return getColor(p,[60,85]);}

function ringSVG(value,max,size,sw,color) {
  const r=(size-sw)/2, c=2*Math.PI*r, pct=Math.min(value/max,1), off=c*(1-pct);
  return `<svg width="${size}" height="${size}" class="transform -rotate-90"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke-width="${sw}" class="ring-bg"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke-width="${sw}" stroke="${color}" stroke-dasharray="${c}" stroke-dashoffset="${off}" class="ring-fill"/></svg>`;
}
function barHTML(v,m,c) { const p=m>0?Math.min((v/m)*100,100):0; return `<div class="bar-track rounded-full h-2 w-full"><div class="bar-fill rounded-full h-2" style="width:${p}%;background:${c}"></div></div>`; }

function sparklineSVG(data, width, height, color) {
  if (!data || data.length < 2) return '';
  const max = Math.max(...data, 1), min = Math.min(...data, 0), range = max - min || 1;
  const step = width / (data.length - 1);
  let path = '';
  data.forEach((v, i) => { const x = i * step; const y = height - ((v - min) / range) * (height - 4) - 2; path += (i===0?'M':'L') + x.toFixed(1) + ',' + y.toFixed(1); });
  return `<svg width="${width}" height="${height}" style="display:inline-block;vertical-align:middle"><path d="${path}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

// ── Tab Switching ──
function switchTab(tab) {
  activeTab = tab;
  ['overview','traffic','history'].forEach(t => {
    document.getElementById('page-'+t).classList.toggle('hidden', t !== tab);
    document.getElementById('tab-'+t).className = t === tab ? 'tab-active pb-2 text-sm font-medium px-1' : 'tab-inactive pb-2 text-sm font-medium px-1';
  });
  renderAll();
}

// ── Overview Tab ──
function renderGPUCard(g, hasEcc) {
  const uc=getUtilColor(g.gpu_util), tc=getTempColor(g.temp||0);
  const pp=g.power_limit>0?(g.power_draw/g.power_limit*100):0, pc=getPowerColor(pp);
  const mp=g.mem_total>0?(g.mem_used/g.mem_total*100):0, mc=getColor(mp,[60,90]);
  return `<div class="gpu-card glass-bright rounded-xl p-4">
    <div class="flex items-center justify-between mb-3"><span class="text-xs font-medium text-gray-400">GPU ${g.index}</span>
      <div class="flex items-center gap-2">${g.fan!==null?`<span class="text-[10px] text-gray-500">${g.fan}% fan</span>`:''} ${hasEcc&&g.ecc_errors!==undefined?`<span class="text-[10px] ${g.ecc_errors>0?'text-red-400':'text-gray-600'}">ECC:${g.ecc_errors}</span>`:''}</div>
    </div>
    <div class="flex items-center gap-4 mb-3">
      <div class="relative flex-shrink-0">${ringSVG(g.gpu_util,100,64,5,uc.ring)}<div class="absolute inset-0 flex items-center justify-center"><span class="text-sm font-semibold ${uc.text}">${g.gpu_util}%</span></div></div>
      <div class="flex-1 space-y-1.5">
        <div class="flex justify-between text-[11px]"><span class="text-gray-500">Temp</span><span class="${tc.text} font-medium">${g.temp!==null?g.temp+'°C':'N/A'}</span></div>
        <div class="flex justify-between text-[11px]"><span class="text-gray-500">Power</span><span class="${pc.text} font-medium">${g.power_draw.toFixed(0)}W/${g.power_limit.toFixed(0)}W</span></div>
      </div>
    </div>
    <div class="space-y-1.5"><div class="flex items-center justify-between text-[11px]"><span class="text-gray-500">VRAM</span><span class="text-gray-400">${formatMiB(g.mem_used)}/${formatMiB(g.mem_total)}</span></div>${barHTML(g.mem_used,g.mem_total,mc.ring)}</div>
  </div>`;
}

function renderOverviewServer(key, d) {
  if (!d || d.status==='offline') {
    return `<div class="glass rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="w-2.5 h-2.5 rounded-full bg-red-500 status-offline"></div><h2 class="text-lg font-semibold text-white">${d?.server_name||key}</h2><span class="text-xs text-gray-500">${d?.host||''}</span></div><div class="text-red-400 text-sm">${d?.error?'Connection failed: '+d.error:'Connecting...'}</div></div>`;
  }
  const gpus=d.gpus||[], procs=d.processes||[];
  const tv=gpus.reduce((s,g)=>s+g.mem_total,0), uv=gpus.reduce((s,g)=>s+g.mem_used,0);
  const au=gpus.length?Math.round(gpus.reduce((s,g)=>s+g.gpu_util,0)/gpus.length):0;
  const tp=gpus.reduce((s,g)=>s+g.power_draw,0), tc=gpus.reduce((s,g)=>s+g.power_limit,0);
  const vp=tv>0?((uv/tv)*100).toFixed(0):0;
  let sys='';
  if(d.ram?.total){sys+=`<div class="flex items-center gap-2"><span class="text-gray-500 text-xs w-12">RAM</span><div class="flex-1">${barHTML(d.ram.used,d.ram.total,'#6366f1')}</div><span class="text-xs text-gray-400 w-28 text-right">${formatBytes(d.ram.used)} / ${formatBytes(d.ram.total)}</span></div>`;}
  if(d.disk?.total){sys+=`<div class="flex items-center gap-2"><span class="text-gray-500 text-xs w-12">Disk</span><div class="flex-1">${barHTML(d.disk.used,d.disk.total,'#8b5cf6')}</div><span class="text-xs text-gray-400 w-28 text-right">${formatBytes(d.disk.used)} / ${formatBytes(d.disk.total)}</span></div>`;}
  let netHtml='';
  if(prevNetData[key]){const dt=(d.timestamp-prevNetData[key].t)||1;const rx=((d.net_rx_bytes-prevNetData[key].rx)*8)/dt;const tx=((d.net_tx_bytes-prevNetData[key].tx)*8)/dt;if(rx>=0&&tx>=0)netHtml=`<div class="flex items-center gap-4 text-[11px] mt-1"><span class="text-gray-500">Net:</span><span class="text-cyan-400">↓ ${formatRate(rx)}</span><span class="text-emerald-400">↑ ${formatRate(tx)}</span></div>`;}
  prevNetData[key]={t:d.timestamp,rx:d.net_rx_bytes,tx:d.net_tx_bytes};
  let procHTML='';
  if(procs.length>0){const up={};procs.forEach(p=>{const k=p.pid+p.name;if(!up[k])up[k]={...p,count:1};else{up[k].mem_used+=p.mem_used;up[k].count++;}});const pl=Object.values(up).sort((a,b)=>b.mem_used-a.mem_used).slice(0,8);procHTML=`<details class="mt-4"><summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Processes (${procs.length})</summary><div class="mt-2 space-y-1">${pl.map(p=>`<div class="flex justify-between text-[11px] text-gray-400 py-1 px-2 rounded hover:bg-white/[0.03]"><span class="truncate flex-1 mr-2">${p.name}</span><span class="text-gray-500 flex-shrink-0">PID ${p.pid} · ${formatMiB(p.mem_used)}</span></div>`).join('')}</div></details>`;}
  return `<div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4"><div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full bg-emerald-500 status-online"></div><h2 class="text-lg font-semibold text-white">${d.server_name}</h2><span class="text-xs text-gray-500 font-mono">${d.host}</span></div><div class="text-xs text-gray-500">up ${formatUptime(d.uptime_seconds)}</div></div>
    <div class="grid grid-cols-4 gap-3 mb-4">
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">GPUs</div><div class="text-lg font-semibold text-white">${gpus.length}</div><div class="text-[10px] text-gray-500">${d.gpu_model.replace('NVIDIA ','').replace('GeForce ','')}</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Avg Util</div><div class="text-lg font-semibold ${getUtilColor(au).text}">${au}%</div><div class="text-[10px] text-gray-500">compute</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Total VRAM</div><div class="text-lg font-semibold text-white">${vp}%</div><div class="text-[10px] text-gray-500">${formatMiB(uv)} / ${formatMiB(tv)}</div></div>
      <div class="glass-bright rounded-lg p-3 text-center"><div class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Power</div><div class="text-lg font-semibold ${getPowerColor(tc>0?tp/tc*100:0).text}">${tp.toFixed(0)}W</div><div class="text-[10px] text-gray-500">/ ${tc.toFixed(0)}W cap</div></div>
    </div>
    <div class="space-y-2 mb-4">${sys}${netHtml}</div>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">${gpus.map(g=>renderGPUCard(g,d.gpu_model.includes('H200'))).join('')}</div>
    ${procHTML}
  </div>`;
}

function renderOverview() {
  document.getElementById('page-overview').innerHTML = `<div class="grid grid-cols-1 2xl:grid-cols-2 gap-6">${SERVERS.map(k=>renderOverviewServer(k,serverData[k])).join('')}</div>`;
}

// ── Traffic Tab ──
function renderVllmService(v) {
  const sm=v.model_name.split('/').pop();
  return `<div class="glass-bright rounded-xl p-4">
    <div class="flex items-center justify-between mb-3"><div><span class="text-sm font-medium text-white">${sm}</span><span class="text-[10px] text-gray-500 ml-2">:${v.port}</span></div>
      <div class="flex items-center gap-2"><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${v.requests_running>0?'bg-emerald-500/20 text-emerald-400':'bg-gray-700/50 text-gray-500'}">${v.requests_running} running</span><span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${v.requests_waiting>0?'bg-amber-500/20 text-amber-400':'bg-gray-700/50 text-gray-500'}">${v.requests_waiting} queued</span></div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Total Requests</div><div class="text-base font-semibold text-white">${fmt(v.total_requests)}</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Prompt Tokens</div><div class="text-base font-semibold text-cyan-400">${(v.prompt_tokens/1e6).toFixed(1)}M</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Gen Tokens</div><div class="text-base font-semibold text-purple-400">${(v.generation_tokens/1e6).toFixed(1)}M</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Success</div><div class="text-base font-semibold text-emerald-400">${fmt(v.success_count)}</div></div>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg TTFT</div><div class="text-sm font-semibold ${v.avg_ttft_ms>500?'text-red-400':v.avg_ttft_ms>200?'text-amber-400':'text-emerald-400'}">${v.avg_ttft_ms.toFixed(0)}ms</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg ITL</div><div class="text-sm font-semibold ${v.avg_itl_ms>100?'text-red-400':v.avg_itl_ms>50?'text-amber-400':'text-emerald-400'}">${v.avg_itl_ms.toFixed(1)}ms</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg E2E</div><div class="text-sm font-semibold text-gray-300">${v.avg_e2e_s.toFixed(2)}s</div></div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Avg Queue</div><div class="text-sm font-semibold ${v.avg_queue_s>1?'text-red-400':v.avg_queue_s>0.5?'text-amber-400':'text-emerald-400'}">${v.avg_queue_s.toFixed(3)}s</div></div>
    </div>
    <div class="grid grid-cols-2 gap-3 mt-3">
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">KV Cache</div><div class="text-sm font-semibold text-white">${v.kv_cache_usage}%</div>${barHTML(v.kv_cache_usage,100,'#f59e0b')}</div>
      <div class="kpi-card rounded-lg p-2.5 bg-white/[0.02]"><div class="text-[10px] text-gray-500 mb-0.5">Prefix Cache Hit</div><div class="text-sm font-semibold text-white">${v.cache_hit_rate}%</div>${barHTML(v.cache_hit_rate,100,'#22c55e')}</div>
    </div>
  </div>`;
}

function renderTraffic() {
  const el=document.getElementById('page-traffic'); let html='';
  for(const key of SERVERS){const d=serverData[key];if(!d||d.status==='offline')continue;const vllm=d.vllm||[];
    if(!vllm.length){html+=`<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white mb-2">${d.server_name}</h3><p class="text-gray-500 text-sm">No vLLM services detected on this server</p></div>`;continue;}
    const tr=vllm.reduce((s,v)=>s+v.total_requests,0),tp=vllm.reduce((s,v)=>s+v.prompt_tokens,0),tg=vllm.reduce((s,v)=>s+v.generation_tokens,0),trn=vllm.reduce((s,v)=>s+v.requests_running,0),tw=vllm.reduce((s,v)=>s+v.requests_waiting,0);
    html+=`<div class="glass rounded-2xl p-6 mb-6"><div class="flex items-center justify-between mb-4 flex-wrap gap-2"><div class="flex items-center gap-3"><div class="w-2.5 h-2.5 rounded-full bg-emerald-500 status-online"></div><h3 class="text-lg font-semibold text-white">${d.server_name}</h3></div><div class="flex gap-4 text-xs flex-wrap"><span class="text-gray-400">Total: <span class="text-white font-semibold">${fmt(tr)}</span> reqs</span><span class="text-gray-400">Prompt: <span class="text-cyan-400 font-semibold">${(tp/1e6).toFixed(1)}M</span> tok</span><span class="text-gray-400">Gen: <span class="text-purple-400 font-semibold">${(tg/1e6).toFixed(1)}M</span> tok</span><span class="text-gray-400">Active: <span class="text-emerald-400 font-semibold">${trn}</span></span><span class="text-gray-400">Queued: <span class="${tw>0?'text-amber-400':'text-gray-500'} font-semibold">${tw}</span></span></div></div><div class="grid grid-cols-1 xl:grid-cols-2 gap-4">${vllm.map(v=>renderVllmService(v)).join('')}</div></div>`;
  }
  if(!html) html='<div class="text-gray-500 text-center py-12">Loading traffic data...</div>';
  el.innerHTML=html;
}

// ── History Tab ──
function renderHistory() {
  const el=document.getElementById('page-history'); let html='';
  for(const key of SERVERS){
    const h=loadHistory(key); const d=serverData[key];
    if(!d||d.status==='offline')continue;
    if(h.length<2){html+=`<div class="glass rounded-2xl p-6 mb-6"><h3 class="text-lg font-semibold text-white mb-2">${d.server_name}</h3><p class="text-gray-500 text-sm">Collecting data... (${h.length} samples so far)</p></div>`;continue;}
    const utils=h.map(p=>p.u),temps=h.map(p=>p.t2),powers=h.map(p=>p.pw),running=h.map(p=>p.rn||0),waiting=h.map(p=>p.wt||0);
    const peakUtil=Math.max(...utils),piU=utils.indexOf(peakUtil),ptU=new Date(h[piU].ts*1000).toLocaleTimeString();
    const peakTemp=Math.max(...temps),peakPower=Math.max(...powers);
    const peakRun=Math.max(...running),piR=running.indexOf(peakRun),ptR=new Date(h[piR].ts*1000).toLocaleTimeString();
    const peakWait=Math.max(...waiting);
    const avgU=(utils.reduce((a,b)=>a+b,0)/utils.length).toFixed(1);
    const avgT=(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1);
    const dur=h.length>1?((h[h.length-1].ts-h[0].ts)/60).toFixed(0):0;
    html+=`<div class="glass rounded-2xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-white">${d.server_name}</h3><span class="text-xs text-gray-500">${h.length} samples over ${dur} min</span></div>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-5">
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Peak GPU Util</div><div class="text-xl font-bold ${getUtilColor(peakUtil).text}">${peakUtil}%</div><div class="text-[10px] text-gray-500">at ${ptU}</div><div class="mt-1">${sparklineSVG(utils.slice(-60),80,20,getUtilColor(peakUtil).ring)}</div></div>
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Avg GPU Util</div><div class="text-xl font-bold ${getUtilColor(parseFloat(avgU)).text}">${avgU}%</div><div class="text-[10px] text-gray-500">over session</div></div>
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Peak Temp</div><div class="text-xl font-bold ${getTempColor(peakTemp).text}">${peakTemp}°C</div><div class="text-[10px] text-gray-500">avg ${avgT}°C</div><div class="mt-1">${sparklineSVG(temps.slice(-60),80,20,getTempColor(peakTemp).ring)}</div></div>
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Peak Power</div><div class="text-xl font-bold text-amber-400">${peakPower.toFixed(0)}W</div><div class="text-[10px] text-gray-500">cluster total</div><div class="mt-1">${sparklineSVG(powers.slice(-60),80,20,'#f59e0b')}</div></div>
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Peak Concurrent</div><div class="text-xl font-bold text-cyan-400">${peakRun}</div><div class="text-[10px] text-gray-500">at ${ptR}</div><div class="mt-1">${sparklineSVG(running.slice(-60),80,20,'#06b6d4')}</div></div>
        <div class="glass-bright rounded-lg p-3"><div class="text-[10px] text-gray-500 uppercase mb-1">Peak Queued</div><div class="text-xl font-bold ${peakWait>0?'text-amber-400':'text-gray-500'}">${peakWait}</div><div class="text-[10px] text-gray-500">max waiting</div><div class="mt-1">${sparklineSVG(waiting.slice(-60),80,20,'#f59e0b')}</div></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass-bright rounded-xl p-4"><div class="text-xs text-gray-400 mb-2">GPU Utilization</div>${sparklineSVG(utils,400,60,'#22c55e')}</div>
        <div class="glass-bright rounded-xl p-4"><div class="text-xs text-gray-400 mb-2">Active Requests</div>${sparklineSVG(running,400,60,'#06b6d4')}</div>
        <div class="glass-bright rounded-xl p-4"><div class="text-xs text-gray-400 mb-2">Temperature</div>${sparklineSVG(temps,400,60,'#ef4444')}</div>
        <div class="glass-bright rounded-xl p-4"><div class="text-xs text-gray-400 mb-2">Power Draw</div>${sparklineSVG(powers,400,60,'#f59e0b')}</div>
      </div>
    </div>`;
  }
  if(!html) html='<div class="text-gray-500 text-center py-12">Collecting history data...</div>';
  el.innerHTML=html;
}

function renderAll() {
  if(activeTab==='overview') renderOverview();
  else if(activeTab==='traffic') renderTraffic();
  else if(activeTab==='history') renderHistory();
}

// ── Fetch & Store ──
const API_BASE = 'http://146.88.194.12:8080';
async function fetchServer(key) {
  try { const r=await fetch(API_BASE+'/api/'+key); return await r.json(); }
  catch(e) { return {server_name:key,status:'offline',error:e.message}; }
}

function recordHistory(key, d) {
  if(!d||d.status==='offline') return;
  const gpus=d.gpus||[], vllm=d.vllm||[];
  const h=loadHistory(key);
  h.push({
    ts: d.timestamp,
    u: gpus.length?Math.round(gpus.reduce((s,g)=>s+g.gpu_util,0)/gpus.length*10)/10:0,
    t2: Math.max(...gpus.map(g=>g.temp||0),0),
    pw: Math.round(gpus.reduce((s,g)=>s+g.power_draw,0)*10)/10,
    rn: vllm.reduce((s,v)=>s+v.requests_running,0),
    wt: vllm.reduce((s,v)=>s+v.requests_waiting,0),
  });
  saveHistory(key, h);
}

async function refresh() {
  const results = await Promise.all(SERVERS.map(k=>fetchServer(k)));
  SERVERS.forEach((k,i)=>{ serverData[k]=results[i]; recordHistory(k,results[i]); });
  renderAll();
  document.getElementById('lastUpdate').textContent='Updated: '+new Date().toLocaleTimeString();
}

function updateRefreshRate() {
  refreshRate=parseInt(document.getElementById('refreshRate').value);
  if(refreshInterval) clearInterval(refreshInterval);
  refreshInterval=setInterval(refresh,refreshRate);
}

// Init
renderOverview();
refresh();
refreshInterval=setInterval(refresh,refreshRate);
</script>
</body>
</html>
